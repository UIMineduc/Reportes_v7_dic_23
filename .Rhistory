# #Se crea BD de reg por rbd
#N alumnos por EE de c/ region
deprov_sost <- bd %>% group_by(cod_reg_rbd2022r2, rbd_2022r) %>% summarise(n = n())
deprov_sost <- deprov_sost %>% group_by(rbd_2022r) %>% filter(n == max(n))
deprov_sost <- deprov_sost %>% ungroup()
#Se pegan los datos de Deprov a bd_asis
nrow(bd_asis)
bd_asis <- left_join(bd_asis, deprov_sost, by = c("rbd" = "rbd_2022r"))
nrow(bd_asis)
sin_datos <- bd_asis %>% filter(is.na(cod_reg_rbd2022r2))
unique(sin_datos$rbd)
## *****FALTAN 80 RBDs CON DATOS DEPROV. PUEDEN SER EE NUEVOS.**********************************************************************
# #Se filtran ee que sean pp
# bd <- bd %>% filter(cod_depe2_2022r != 3)
bd_asis <- bd_asis %>% filter(cod_depe2 != 3)
data_plot4_n <- bd %>% group_by(rut_sost_rbd2022, nom_rbd_2022r, rbd_2022r) %>% summarise(n_total = n()) %>% ungroup()  #**
data_plot4_n_2 <- bd_asis %>% group_by(rut_sost_rbd2022, nom_rbd, rbd) %>% summarise(n_total = n())  %>% ungroup()   #**
data_plot6_n <- bd_asis %>% group_by(rut_sost_rbd2022, nom_rbd, rbd) %>% summarise(n_total = n()) %>% ungroup()   #**
#data_plot3_n <- bd_asis %>% group_by(rbd, cod_curso) %>% summarise(n_total = n()) %>% ungroup()
#Se arma bd para retirados
bd2 <- bd %>% filter(categoria_desert == "Retirado 2023")
bd2 <- left_join(bd2, bd_desvinc_intran_r2, by = c("run_alu" = "run_alu_ret"))
#bd2 <- left_join(bd2, nom_grad, by = c("cod_ense_ret" = "cod_ense", "cod_grado_ret" = "cod_grado"))
head(bd2$fec_ret_rbd_ret)
bd2$fec_ret_rbd_ret <- format(as.Date(as.character(bd2$fec_ret_rbd_ret), "%Y%m%d"),"%d/%m/%Y")
head(bd2$fec_ret_rbd_ret)
#Ajuste nombre que tira error
bd2 <- bd2 %>% mutate(nom_alu_ret = ifelse(run_alu == "100565271","DJOULISSA",nom_alu_ret))
bd2 <- bd2 %>% filter(!grepl("Adult.", nom_grado, fixed=TRUE))
bd2 <- bd2 %>% filter(!grepl("Adult.", nom_grado_ret, fixed=TRUE))
#Datos de asistencia por EE para tabla 2.1 y 2.2
#resumen_asis_ee <- bd_asis %>% filter(cod_depe != 4) %>% group_by(rut_sost_rbd2022, nom_rbd, rbd) %>% summarise(asis_marzo= mean(porcentage_asistencia_marzo, na.rm = TRUE), asis_abril = mean(porcentage_asistencia_abril, na.rm = TRUE), asis_mayo = mean(porcentage_asistencia_mayo, na.rm = TRUE), asis_promedio = mean(porcentage_asistencia_acumulada, na.rm = TRUE), n_total = n(), n = sum(inasistencia_grave_acumulada))
resumen_asis_ee <- bd_asis %>% filter(cod_depe2 != 3) %>% filter(!is.na(inasistencia_grave_acumulada)) %>% group_by(rut_sost_rbd2022, nom_rbd, rbd) %>% summarise(asis_marzo= mean(porcentage_asistencia_marzo, na.rm = TRUE),
asis_abril = mean(porcentage_asistencia_abril, na.rm = TRUE), asis_mayo = mean(porcentage_asistencia_mayo, na.rm = TRUE),
asis_junio = mean(porcentage_asistencia_junio, na.rm = TRUE), asis_julio = mean(porcentage_asistencia_julio, na.rm = TRUE), asis_agosto = mean(porcentage_asistencia_agosto, na.rm = TRUE),
asis_septiembre = mean(porcentage_asistencia_septiembre, na.rm = TRUE), asis_octubre = mean(porcentage_asistencia_octubre, na.rm = TRUE),
#asis_noviembre = mean(porcentage_asistencia_noviembre, na.rm = TRUE),
asis_promedio = mean(porcentage_asistencia_acumulada, na.rm = TRUE), n_total = n(), n = sum(inasistencia_grave_acumulada, na.rm = T))
table(bd_asis$inasistencia_grave_acumulada, useNA = "a")
table(bd_asis$cod_deprov_rbd, useNA = "a")
resumen_asis_ee <- resumen_asis_ee %>% mutate(porc_asis_crit = ifelse(n_total > 0, round(n/n_total,3), 0))
resumen_asis_ee <- resumen_asis_ee %>% ungroup()
resumen_asis_ee <- resumen_asis_ee %>% arrange(desc(porc_asis_crit))
resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_marzo = paste0(round(asis_marzo*100, 1),"%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_abril = paste0(round(asis_abril*100, 1),"%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_mayo = paste0(round(asis_mayo*100, 1),"%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_junio = paste0(round(asis_junio*100, 1),"%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_julio = paste0(round(asis_julio*100, 1),"%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_agosto = paste0(round(asis_agosto*100, 1),"%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_septiembre = paste0(round(asis_septiembre*100, 1),"%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_octubre = paste0(round(asis_octubre*100, 1),"%"))
# resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_noviembre = paste0(round(asis_noviembre*100, 1),"%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(asis_promedio = paste0(round(asis_promedio*100, 1),"%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(porc_asis_crit = paste0(round(porc_asis_crit*100, 1),"%"))
print(resumen_asis_ee)
#resumen_asis_ee2 <- bd_asis %>% filter(cod_depe != 4) %>% group_by(rut_sost_rbd2022, nom_rbd, rbd, asistencia_categorias1) %>% summarise(n_cat = n())
resumen_asis_ee2 <- bd_asis %>% filter(cod_depe2 != 3) %>% group_by(rut_sost_rbd2022, nom_rbd, rbd, asistencia_categorias_acumulada) %>% summarise(n_cat = n())
resumen_asis_ee2 <- resumen_asis_ee2 %>% ungroup()
resumen_asis_ee2
resumen_asis_ee2 <- resumen_asis_ee2 %>% pivot_wider(names_from = asistencia_categorias_acumulada, values_from = n_cat)
#resumen_asis_ee2 <- resumen_asis_ee2 %>% mutate(total)
resumen_asis_ee2 %>% filter(`NA` > 0)
nrow(resumen_asis_ee2)
nrow(resumen_asis_ee)
#resumen_asis_ee = left_join(resumen_asis_ee, resumen_asis_ee2, by = c("rut_sost_rbd2022", "nom_rbd", "rbd"))
resumen_asis_ee = left_join(resumen_asis_ee, resumen_asis_ee2, by = c("rut_sost_rbd2022", "nom_rbd", "rbd"))
resumen_asis_ee
# resumen_asis_ee <- resumen_asis_ee %>% rowwise() %>% mutate(n_total2 = sum(`1`, `2`, `3`, `4`, `5`, na.rm = T))
resumen_asis_ee <- resumen_asis_ee %>% rowwise() %>% mutate(n_total2 = sum(`1`, `2`, `3`, `4`, `NA`, na.rm = T))
resumen_asis_ee <- resumen_asis_ee %>% mutate(porc1 = ifelse(!is.na(`1`), paste0(100*round(`1`/n_total2, 3),"%"), "0%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(porc2 = ifelse(!is.na(`2`), paste0(100*round(`2`/n_total2, 3),"%"), "0%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(porc3 = ifelse(!is.na(`3`), paste0(100*round(`3`/n_total2, 3),"%"), "0%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(porc4 = ifelse(!is.na(`4`), paste0(100*round(`4`/n_total2, 3),"%"), "0%"))
resumen_asis_ee <- resumen_asis_ee %>% mutate(sin_info = ifelse(!is.na(`NA`), paste0(100*round(`NA`/n_total2, 3),"%"), "0%"))
# resumen_asis_ee <- resumen_asis_ee %>% mutate(porc5 = ifelse(!is.na(`5`), paste0(100*round(`5`/n_total2, 3),"%"), "0%"))
#Datos de desvinculados por EE para tabla 1.1
bd <- bd %>% mutate(retirados = ifelse(categoria_desert == "Retirado 2023",1,0))
bd2 <- bd2 %>% mutate(retirados = ifelse(categoria_desert == "Retirado 2023",1,0))
bd <- bd %>% mutate(desvinculados = ifelse(categoria_desert == "Desercion incidencia",1,0))
#Se calculan los retirados por rbd
n_ret_rbd <- bd2 %>%  group_by(rbd_ret) %>% summarise(n_ret = sum(retirados)) %>% ungroup() %>% select(rbd_ret, n_ret)
data_plot4_n_2 <- left_join(data_plot4_n_2, n_ret_rbd, by=c("rbd" = "rbd_ret"))
data_plot4_n_2 <- data_plot4_n_2 %>% rename(n_total0 = n_total)
data_plot4_n_2 <- data_plot4_n_2 %>% mutate(n_ret = ifelse(is.na(n_ret),0,n_ret))
data_plot4_n_2 <- data_plot4_n_2 %>% mutate(n_total = n_total0 + n_ret)
mat_2023_ee <- bd_asis %>% group_by(rbd) %>% summarise(n_total23 = n()) %>% ungroup()
mat_2023_ee <- mat_2023_ee %>% rename(rbd_2022r = rbd)
#resumen_desvinc_ee <- bd  %>%  group_by(rut_sost_rbd2022, nom_rbd2022r, rbd2022r, curso2022r) %>% summarise(n_total = n(), n = sum(deserta_aju_mayo))  #Para informe sostenedores
resumen_desvinc_ee <- bd %>%
group_by(rut_sost_rbd2022, nom_rbd_2022r, rbd_2022r) %>%
summarise(n_total = n(), n_desv = sum(desvinculados))
#summarise(n_total = n(), n = sum(desert_glob_total_aju_marzo_2023))
resumen_desvinc_ee2 <- bd2 %>%
group_by(rut_sost_rbd2022_ret, nom_rbd_ret, rbd_ret) %>%
summarise(n_ret = sum(retirados)) %>%
ungroup() %>%
select(rbd_ret, n_ret)#summarise(n_total = n(), n = sum(desert_glob_total_aju_marzo_2023))
resumen_dobledesvinc_ee <- doble_desvinc %>%
group_by(rbd) %>%
summarise(n_dobledesv = n()) %>%
ungroup() %>%
select(rbd, n_dobledesv)#summarise(n_total = n(), n = sum(desert_glob_total_aju_marzo_2023))
resumen_desvinc_ee <- full_join(mat_2023_ee, resumen_desvinc_ee, by = c("rbd_2022r" = "rbd_2022r"))
resumen_desvinc_ee <- full_join(resumen_desvinc_ee, resumen_desvinc_ee2, by = c("rbd_2022r" = "rbd_ret"))
resumen_desvinc_ee <- left_join(resumen_desvinc_ee, resumen_dobledesvinc_ee, by = c("rbd_2022r" = "rbd"))
resumen_desvinc_ee <- resumen_desvinc_ee %>% ungroup()
resumen_desvinc_ee <- resumen_desvinc_ee%>% mutate(n_ret = ifelse(is.na(n_ret), 0, n_ret))
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(n_desv = ifelse(is.na(n_desv), 0, n_desv))
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(n_dobledesv = ifelse(is.na(n_dobledesv), 0, n_dobledesv))
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(n_total23 = n_total23 + n_ret)
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(n_total23 = ifelse(is.na(n_total23), 0, n_total23))
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(porc_desvinc = ifelse(n_total > 0, round(n_desv/n_total,3), 0))
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(porc_ret = ifelse(n_total23 > 0, round(n_ret/n_total23,3), 0))
###Se crean las variables con el cálculo usado para la desvinculación 2023
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(n_mat_teo_total23 = n_total23 + n_desv)
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(n_mat_teo_total23 = ifelse(is.na(n_mat_teo_total23), 0, n_mat_teo_total23))
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(desv_total23 = n_ret + n_desv)
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(porc_total23 = ifelse(n_mat_teo_total23 != 0, round(desv_total23/n_mat_teo_total23, 3), 0))
#Se ordena para que aparezcan primero los con más desvinculados.
resumen_desvinc_ee <- resumen_desvinc_ee %>% arrange(desc(porc_total23))
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(porc_desvinc = ifelse(!is.na(porc_desvinc), paste0(round(porc_desvinc*100, 1),"%"), NA))
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(porc_ret = ifelse(!is.na(porc_ret), paste0(round(porc_ret*100, 1),"%"), NA))
resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(porc_total23 = ifelse(!is.na(porc_total23), paste0(round(porc_total23*100, 1),"%"), NA))
#resumen_desvinc_ee <- resumen_desvinc_ee %>% arrange(nom_rbd_2022r, curso2022r) #Para informe sostenedores
#resumen_desvinc_ee <- resumen_desvinc_ee %>% arrange(porc_total23)
#
#
#
# resumen_desvinc_ee <-resumen_desvinc_ee %>% mutate(n_ret = ifelse(is.na(n_ret), 0, n_ret))
# resumen_desvinc_ee <-resumen_desvinc_ee %>% mutate(n_dobledesv = ifelse(is.na(n_dobledesv), 0, n_dobledesv))
#
# resumen_desvinc_ee <- left_join(mat_2023_com, resumen_desvinc_ee, by=c("rbd" =  "rbd_2022r"))
# resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(n_total23 = n_total23 + n_ret)
#
# resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(porc_ret = ifelse(n_total23 > 0, round(n_ret/n_total23,3), 0))
# resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(porc_ret = ifelse(!is.na(porc_ret), paste0(round(porc_ret*100, 1),"%"), NA))
#resumen_desvinc_ee <- resumen_desvinc_ee %>% arrange(nom_rbd2022r, curso2022r) #Para informe sostenedores
#resumen_desvinc_ee$cod_depe2_2022r <- factor(resumen_desvinc_ee$cod_depe2_2022r, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
#resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(nom_rbd2022r = paste0(nom_rbd2022r, " (RBD: ", rbd2022r, ")") )  #Para informe sostenedores
#print(resumen_desvinc_ee)
## Se ajusta el nombre de los EEs en las bases de datos agregando el rbd
#resumen_desvinc_ee <- resumen_desvinc_ee %>% mutate(nom_rbd_2022r = paste0(nom_rbd_2022r, " (RBD: ", rbd_2022r, ")") )
#resumen_asis_ee <- resumen_asis_ee %>% mutate(nom_rbd = paste0(nom_rbd, " (RBD: ", rbd, ")") )
# table(bd_asis$nom_deprov_rbd, useNA = "a")
# table(bd_asis$nombre_sost_rbd, useNA = "a")
# colnames(bd)
#Se pegan los datos de matrícula 2023 a la bd de desvinculados y retirados
mat_2023_ee <- bd_asis %>% group_by(rbd) %>% summarise(n_total23 = n()) %>% ungroup()
mat_2023_ee_cur <- bd_asis %>% group_by(rbd, cod_curso) %>% summarise(n_total23 = n()) %>% ungroup()
mat_2023_ee <- mat_2023_ee %>% rename(rbd_2022r = rbd)
mat_2023_ee_cur <- mat_2023_ee_cur %>% rename(nom_grado = cod_curso, rbd_2022r = rbd)
#colnames(bd_asis)
datos_rbd2023 <- bd_asis %>% group_by(rbd) %>% slice(1) %>% select(rbd, cod_depe2, nom_rbd, cod_deprov_rbd, nom_deprov_rbd, cod_com_rbd, nom_com_rbd, cod_reg_rbd, cod_reg_rbd2022r2, rut_sost_rbd2022, nombre_sost_rbd2022, email_sost_rbd2022, tel_sost_rbd)
datos_rbd2022 <- bd %>% group_by(rbd_2022r) %>% slice(1) %>% select(rbd_2022r, nom_deprov_rbd2022, cod_deprov_rbd2022, cod_depe2_2022r, nom_rbd_2022r, cod_com_rbd_2022r, nom_com_rbd_2022r, cod_reg_rbd2022r2, rut_sost_rbd2022, nombre_sost_rbd2022, email_sost_rbd2022, tel_sost_rbd)
colnames(datos_rbd2022) <- paste0(colnames(datos_rbd2022),"_t_1")
#Datos de desvinculados por EE y curso para EXCEL
# xls_desvinc_ee_cur_pre <- bd_asis  %>%  group_by(rut_sost_rbd2022, rbd_2022r, nom_grado)
xls_desvinc_ee_cur <- bd  %>%  group_by(rbd_2022r, nom_grado) %>% summarise(n_total = n(), n_desv = sum(desvinculados, na.rm = T))
xls_desvinc_ee_cur2 <- bd2  %>%  group_by(rbd_ret, nom_grado_ret) %>% summarise(n_ret = sum(retirados, na.rm = T)) %>% ungroup() %>% select(rbd_ret, nom_grado_ret, n_ret)
xls_dobledesvinc_ee_cur <- doble_desvinc %>% group_by(rbd, nom_grado) %>% summarise(n_dobledesv = n()) %>% ungroup() %>% select(rbd, nom_grado, n_dobledesv)
xls_desvinc_ee_cur <- full_join(mat_2023_ee_cur, xls_desvinc_ee_cur, by = c("rbd_2022r" = "rbd_2022r", "nom_grado" = "nom_grado"))
xls_desvinc_ee_cur <- full_join(xls_desvinc_ee_cur, xls_desvinc_ee_cur2, by = c("rbd_2022r" = "rbd_ret", "nom_grado" = "nom_grado_ret"))
xls_desvinc_ee_cur <- left_join(xls_desvinc_ee_cur, xls_dobledesvinc_ee_cur, by = c("rbd_2022r" = "rbd", "nom_grado" = "nom_grado"))
colnames(datos_rbd2022)
xls_desvinc_ee_cur <- left_join(xls_desvinc_ee_cur, datos_rbd2023, by = c("rbd_2022r" = "rbd"))
xls_desvinc_ee_cur <- left_join(xls_desvinc_ee_cur, datos_rbd2022, by = c("rbd_2022r" = "rbd_2022r_t_1"))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% arrange(nom_rbd, nom_grado)
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% ungroup()
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_ret = ifelse(is.na(n_ret), 0, n_ret))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_desv = ifelse(is.na(n_desv), 0, n_desv))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_dobledesv = ifelse(is.na(n_dobledesv), 0, n_dobledesv))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(porc_desvinc = ifelse(n_total > 0, round(n_desv/n_total,3), 0))
colnames(xls_desvinc_ee_cur)
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(cod_reg_rbd2022r2 = if_else(is.na(cod_reg_rbd2022r2), cod_reg_rbd2022r2_t_1, cod_reg_rbd2022r2))  #TAGDEPROV
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(nom_deprov_rbd = ifelse(is.na(nom_deprov_rbd), nom_deprov_rbd2022_t_1, nom_deprov_rbd))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(nom_com_rbd = ifelse(is.na(nom_com_rbd), nom_com_rbd_2022r_t_1, nom_com_rbd))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(nombre_sost_rbd2022 = ifelse(is.na(nombre_sost_rbd2022), nombre_sost_rbd2022_t_1, nombre_sost_rbd2022))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(rut_sost_rbd2022 = ifelse(is.na(rut_sost_rbd2022), rut_sost_rbd2022_t_1, rut_sost_rbd2022))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(email_sost_rbd2022 = ifelse(is.na(email_sost_rbd2022), email_sost_rbd2022_t_1, email_sost_rbd2022))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(tel_sost_rbd = ifelse(is.na(tel_sost_rbd), tel_sost_rbd_t_1, tel_sost_rbd))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(cod_depe2 = ifelse(is.na(cod_depe2), cod_depe2_2022r_t_1, cod_depe2))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(nom_rbd = ifelse(is.na(nom_rbd), nom_rbd_2022r_t_1, nom_rbd))
#Datos de desvinculados por EE para EXCEL
xls_desvinc_ee <- bd %>%  group_by(rbd_2022r) %>% summarise(n_total = n(), n_desv = sum(desvinculados, na.rm = T)) # sum(desert_glob_total_aju_marzo_2023))
xls_desvinc_ee2 <- bd2  %>%  group_by(rbd_ret) %>% summarise(n_ret = sum(retirados, na.rm = T)) %>% ungroup() %>% select(rbd_ret, n_ret)
xls_dobledesvinc_ee <- doble_desvinc %>% group_by(rbd) %>% summarise(n_dobledesv = n()) %>% ungroup() %>% select(rbd, n_dobledesv)
xls_desvinc_ee <- full_join(mat_2023_ee, xls_desvinc_ee, by = c("rbd_2022r" = "rbd_2022r"))
xls_desvinc_ee <- full_join(xls_desvinc_ee, xls_desvinc_ee2, by = c("rbd_2022r" = "rbd_ret"))
xls_desvinc_ee <- left_join(xls_desvinc_ee, xls_dobledesvinc_ee, by = c("rbd_2022r" = "rbd"))
#nombre_reg <- bd_asis %>% group_by(cod_reg_rbd) %>% slice(1) %>% select(cod_reg_rbd, cod_reg_rbd2022r2)
xls_desvinc_ee <- left_join(xls_desvinc_ee, datos_rbd2023, by = c("rbd_2022r" = "rbd"))
xls_desvinc_ee <- left_join(xls_desvinc_ee, datos_rbd2022, by = c("rbd_2022r" = "rbd_2022r_t_1"))
xls_desvinc_ee <- xls_desvinc_ee %>% arrange(nom_rbd)
xls_desvinc_ee <- xls_desvinc_ee %>% ungroup()
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(cod_reg_rbd2022r2 = if_else(is.na(cod_reg_rbd2022r2), cod_reg_rbd2022r2_t_1, cod_reg_rbd2022r2))  #TAGDEPROV
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(nom_deprov_rbd = ifelse(is.na(nom_deprov_rbd), nom_deprov_rbd2022_t_1, nom_deprov_rbd))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(nom_com_rbd = ifelse(is.na(nom_com_rbd), nom_com_rbd_2022r_t_1, nom_com_rbd))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(nombre_sost_rbd2022 = ifelse(is.na(nombre_sost_rbd2022), nombre_sost_rbd2022_t_1, nombre_sost_rbd2022))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(rut_sost_rbd2022 = ifelse(is.na(rut_sost_rbd2022), rut_sost_rbd2022_t_1, rut_sost_rbd2022))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(email_sost_rbd2022 = ifelse(is.na(email_sost_rbd2022), email_sost_rbd2022_t_1, email_sost_rbd2022))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(tel_sost_rbd = ifelse(is.na(tel_sost_rbd), tel_sost_rbd_t_1, tel_sost_rbd))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(cod_depe2 = ifelse(is.na(cod_depe2), cod_depe2_2022r_t_1, cod_depe2))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(nom_rbd = ifelse(is.na(nom_rbd), nom_rbd_2022r_t_1, nom_rbd))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(n_ret = ifelse(is.na(n_ret), 0, n_ret))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_ret = ifelse(is.na(n_ret), 0, n_ret))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(n_desv = ifelse(is.na(n_desv), 0, n_desv))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_desv = ifelse(is.na(n_desv), 0, n_desv))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(n_dobledesv = ifelse(is.na(n_dobledesv), 0, n_dobledesv))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_dobledesv = ifelse(is.na(n_dobledesv), 0, n_dobledesv))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(porc_desvinc = ifelse(n_total > 0, round(n_desv/n_total,3), 0))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(porc_desvinc = ifelse(n_total > 0, round(n_desv/n_total,3), 0))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(n_total23 = n_total23 + n_ret)
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_total23 = n_total23 + n_ret)
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(n_total23 = ifelse(is.na(n_total23), 0, n_total23))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_total23 = ifelse(is.na(n_total23), 0, n_total23))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(porc_ret = ifelse(n_total23 > 0, round(n_ret/n_total23,3), 0))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(porc_ret = ifelse(n_total23 > 0, round(n_ret/n_total23,3), 0))
###Se crean las variables con el cálculo usado para la desvinculación 2023
xls_desvinc_ee <-   xls_desvinc_ee %>% mutate(n_mat_teo_total23 = n_total23 + n_desv)
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_mat_teo_total23 = n_total23 + n_desv)
xls_desvinc_ee <- xls_desvinc_ee %>% mutate(n_mat_teo_total23 = ifelse(is.na(n_mat_teo_total23), 0, n_mat_teo_total23))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(n_mat_teo_total23 = ifelse(is.na(n_mat_teo_total23), 0, n_mat_teo_total23))
xls_desvinc_ee <-   xls_desvinc_ee %>% mutate(desv_total23 = n_ret + n_desv)
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(desv_total23 = n_ret + n_desv + n_dobledesv)
xls_desvinc_ee <-   xls_desvinc_ee %>% mutate(porc_total23 = ifelse(n_mat_teo_total23 != 0, round(desv_total23/n_mat_teo_total23, 3), 0))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate(porc_total23 = ifelse(n_mat_teo_total23 != 0, round(desv_total23/n_mat_teo_total23, 3), 0))
#Datos de asistencia por EE y curso para EXCEL
xsl_asis_ee_cur <- bd_asis %>% filter(cod_depe2 != 3) %>% group_by(rbd, cod_curso) %>% summarise(asis_marzo= mean(porcentage_asistencia_marzo, na.rm = TRUE),
asis_abril = mean(porcentage_asistencia_abril, na.rm = TRUE), asis_mayo = mean(porcentage_asistencia_mayo, na.rm = TRUE),
asis_junio = mean(porcentage_asistencia_junio, na.rm = TRUE),
asis_julio = mean(porcentage_asistencia_julio, na.rm = TRUE), asis_agosto = mean(porcentage_asistencia_agosto, na.rm = TRUE),
asis_septiembre = mean(porcentage_asistencia_septiembre, na.rm = TRUE), asis_octubre = mean(porcentage_asistencia_octubre, na.rm = TRUE),
#asis_noviembre = mean(porcentage_asistencia_noviembre, na.rm = TRUE),
asis_promedio = mean(porcentage_asistencia_acumulada, na.rm = TRUE), n_total = n(), n = sum(inasistencia_grave_acumulada, na.rm = T))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(porc_asis_crit = ifelse(n_total > 0, round(n/n_total,3), 0))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% ungroup()
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% arrange(asis_promedio)
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_marzo = round(asis_marzo, 3))           #paste0(round(asis_marzo*100, 1),"%"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_abril = round(asis_abril, 3))           #paste0(round(asis_abril*100, 1),"%"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_mayo = round(asis_mayo, 3))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_junio = round(asis_junio, 3)) #paste0(round(asis_mayo*100, 1),"%"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_julio = round(asis_julio, 3))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_agosto = round(asis_agosto, 3))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_septiembre = round(asis_septiembre, 3))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_octubre = round(asis_octubre, 3))
# xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_noviembre = round(asis_noviembre, 3))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(asis_promedio = round(asis_promedio, 3))        #paste0(round(asis_promedio*100, 1),"%"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(porc_asis_crit = round(porc_asis_crit, 3))       #paste0(round(porc_asis_crit*100, 1),"%"))
print(xsl_asis_ee_cur)
xsl_asis_ee_cur2 <- bd_asis %>% filter(cod_depe2 != 3) %>% group_by(rbd, cod_curso, asistencia_categorias_acumulada) %>% summarise(n_cat = n())
xsl_asis_ee_cur2 <- xsl_asis_ee_cur2 %>% ungroup()
xsl_asis_ee_cur2
xsl_asis_ee_cur2 <- xsl_asis_ee_cur2 %>% pivot_wider(names_from = asistencia_categorias_acumulada, values_from = n_cat)
xsl_asis_ee_cur2 %>% filter(`NA` > 0)
nrow(xsl_asis_ee_cur2)
nrow(xsl_asis_ee_cur)
xsl_asis_ee_cur = left_join(xsl_asis_ee_cur, xsl_asis_ee_cur2, by = c("rbd", "cod_curso"))
xsl_asis_ee_cur
# xsl_asis_ee_cur <- xsl_asis_ee_cur %>% rowwise() %>% mutate(n_total2 = sum(`1`, `2`, `3`, `4`, `5`, na.rm = T))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% rowwise() %>% mutate(n_total2 = sum(`1`, `2`, `3`, `4`, `NA`, na.rm = T))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(porc1 = ifelse(!is.na(`1`), round(`1`/n_total2, 3), 0))      #ifelse(!is.na(`1`), paste0(100*round(`1`/n_total2, 3),"%"), "0%"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(porc2 = ifelse(!is.na(`2`), round(`2`/n_total2, 3), 0))      #ifelse(!is.na(`2`), paste0(100*round(`2`/n_total2, 3),"%"), "0%"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(porc3 = ifelse(!is.na(`3`), round(`3`/n_total2, 3), 0))      #ifelse(!is.na(`3`), paste0(100*round(`3`/n_total2, 3),"%"), "0%"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(porc4 = ifelse(!is.na(`4`), round(`4`/n_total2, 3), 0))      #ifelse(!is.na(`4`), paste0(100*round(`4`/n_total2, 3),"%"), "0%"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(sin_info = ifelse(!is.na(`NA`), round(`NA`/n_total2, 3), NA))
# xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate(porc5 = ifelse(!is.na(`5`), round(`5`/n_total2, 3), 0))      #ifelse(!is.na(`5`), paste0(100*round(`5`/n_total2, 3),"%"), "0%"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% arrange(desc(porc_asis_crit))
xsl_asis_ee_cur <- left_join(xsl_asis_ee_cur, datos_rbd2023, by = c("rbd"))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% arrange(nom_rbd)
print(xsl_asis_ee_cur)
#Datos de asistencia por EE para EXCEL
xsl_asis_ee <- bd_asis %>% filter(cod_depe2 != 3) %>% group_by(rbd) %>% summarise(asis_marzo= mean(porcentage_asistencia_marzo, na.rm = TRUE),
asis_abril = mean(porcentage_asistencia_abril, na.rm = TRUE), asis_mayo = mean(porcentage_asistencia_mayo, na.rm = TRUE),
asis_junio = mean(porcentage_asistencia_junio, na.rm = TRUE),
asis_julio = mean(porcentage_asistencia_julio, na.rm = TRUE), asis_agosto = mean(porcentage_asistencia_agosto, na.rm = TRUE),
asis_septiembre = mean(porcentage_asistencia_septiembre, na.rm = TRUE), asis_octubre = mean(porcentage_asistencia_octubre, na.rm = TRUE),
#asis_noviembre = mean(porcentage_asistencia_noviembre, na.rm = TRUE),
asis_promedio = mean(porcentage_asistencia_acumulada, na.rm = TRUE), n_total = n(), n = sum(inasistencia_grave_acumulada, na.rm = T))
xsl_asis_ee <- xsl_asis_ee %>% mutate(porc_asis_crit = ifelse(n_total > 0, round(n/n_total,3), 0))
xsl_asis_ee <- xsl_asis_ee %>% ungroup()
xsl_asis_ee <- xsl_asis_ee %>% arrange(asis_promedio)
xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_marzo = round(asis_marzo, 3))           #paste0(round(asis_marzo*100, 1),"%"))
xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_abril = round(asis_abril, 3))           #paste0(round(asis_abril*100, 1),"%"))
xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_mayo = round(asis_mayo, 3))
xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_junio = round(asis_junio, 3))
xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_julio = round(asis_julio, 3))
xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_agosto = round(asis_agosto, 3))
xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_septiembre = round(asis_septiembre, 3))
xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_octubre = round(asis_octubre, 3))
# xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_noviembre = round(asis_noviembre, 3))
xsl_asis_ee <- xsl_asis_ee %>% mutate(asis_promedio = round(asis_promedio, 3))        #paste0(round(asis_promedio*100, 1),"%"))
xsl_asis_ee <- xsl_asis_ee %>% mutate(porc_asis_crit = round(porc_asis_crit, 3))       #paste0(round(porc_asis_crit*100, 1),"%"))
print(xsl_asis_ee)
xsl_asis_ee2 <- bd_asis %>% filter(cod_depe2 != 3) %>% group_by(rbd, asistencia_categorias_acumulada) %>% summarise(n_cat = n())
xsl_asis_ee2 <- xsl_asis_ee2 %>% ungroup()
xsl_asis_ee2
xsl_asis_ee2 <- xsl_asis_ee2 %>% pivot_wider(names_from = asistencia_categorias_acumulada, values_from = n_cat)
xsl_asis_ee2 %>% filter(`NA` > 0)
nrow(xsl_asis_ee2)
nrow(xsl_asis_ee)
xsl_asis_ee = left_join(xsl_asis_ee, xsl_asis_ee2, by = "rbd")
xsl_asis_ee
# xsl_asis_ee <- xsl_asis_ee %>% rowwise() %>% mutate(n_total2 = sum(`1`, `2`, `3`, `4`, `5`, na.rm = T))
xsl_asis_ee <- xsl_asis_ee %>% rowwise() %>% mutate(n_total2 = sum(`1`, `2`, `3`, `4`, `NA`, na.rm = T))
xsl_asis_ee <- xsl_asis_ee %>% mutate(porc1 = ifelse(!is.na(`1`), round(`1`/n_total2, 3), 0))      #ifelse(!is.na(`1`), paste0(100*round(`1`/n_total2, 3),"%"), "0%"))
xsl_asis_ee <- xsl_asis_ee %>% mutate(porc2 = ifelse(!is.na(`2`), round(`2`/n_total2, 3), 0))      #ifelse(!is.na(`2`), paste0(100*round(`2`/n_total2, 3),"%"), "0%"))
xsl_asis_ee <- xsl_asis_ee %>% mutate(porc3 = ifelse(!is.na(`3`), round(`3`/n_total2, 3), 0))      #ifelse(!is.na(`3`), paste0(100*round(`3`/n_total2, 3),"%"), "0%"))
xsl_asis_ee <- xsl_asis_ee %>% mutate(porc4 = ifelse(!is.na(`4`), round(`4`/n_total2, 3), 0))      #ifelse(!is.na(`4`), paste0(100*round(`4`/n_total2, 3),"%"), "0%"))
xsl_asis_ee <- xsl_asis_ee %>% mutate(sin_info = ifelse(!is.na(`NA`), round(`NA`/n_total2, 3), NA))
# xsl_asis_ee <- xsl_asis_ee %>% mutate(porc5 = ifelse(!is.na(`5`), round(`5`/n_total2, 3), 0))      #ifelse(!is.na(`5`), paste0(100*round(`5`/n_total2, 3),"%"), "0%"))
xsl_asis_ee <- xsl_asis_ee %>% arrange(desc(porc_asis_crit))
xsl_asis_ee <- left_join(xsl_asis_ee, datos_rbd2023, by = c("rbd"))
xsl_asis_ee <- xsl_asis_ee %>% arrange(nom_rbd)
print(xsl_asis_ee)
#Se reordenan por comuna
xsl_asis_ee <- xsl_asis_ee %>% arrange(nom_rbd)
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% arrange(nom_rbd)
xls_desvinc_ee <- xls_desvinc_ee %>% arrange(nom_rbd)
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% arrange(nom_rbd)
xsl_asis_ee$cod_depe2 <- factor(xsl_asis_ee$cod_depe2, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
xsl_asis_ee_cur$cod_depe2 <- factor(xsl_asis_ee_cur$cod_depe2, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
xls_desvinc_ee$cod_depe2_2022r <- factor(xls_desvinc_ee$cod_depe2, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
xls_desvinc_ee_cur$cod_depe2_2022r <- factor(xls_desvinc_ee_cur$cod_depe2, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
#AJUSTES DE COLUMNAS Y NOMBRES
#ASISTENCIA POR RBD
xsl_asis_ee <- xsl_asis_ee %>% select(rut_sost_rbd2022, rbd, nom_rbd, cod_reg_rbd2022r2, nom_com_rbd, rut_sost_rbd2022, asis_marzo,
asis_abril, asis_mayo,
asis_junio, asis_julio, asis_agosto,
asis_septiembre, asis_octubre,
#asis_noviembre,
# asis_promedio, n_total, n, porc_asis_crit, "1", "2", "3", "4", "5", "NA", porc1, porc2, porc3,
asis_promedio, n_total, n, porc_asis_crit, "1", "2", "3", "4", "NA", porc1, porc2, porc3, porc4, sin_info) # n_total2
#ASISTENCIA POR RBD Y CURSO
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% select(rut_sost_rbd2022, rbd, nom_rbd, cod_reg_rbd2022r2, nom_com_rbd, rut_sost_rbd2022, cod_curso, asis_marzo,
asis_abril, asis_mayo,
asis_junio, asis_julio, asis_agosto,
asis_septiembre, asis_octubre,
#asis_noviembre,
# asis_promedio, n_total, n, porc_asis_crit, "1", "2", "3", "4", "5", "NA", porc1, porc2, porc3, porc4, porc5) # n_total2
asis_promedio, n_total, n, porc_asis_crit, "1", "2", "3", "4", "NA", porc1, porc2, porc3, porc4, sin_info) # n_total2
#DESVINCULADOS POR RBD
xls_desvinc_ee <- xls_desvinc_ee %>% select(rut_sost_rbd2022, rbd_2022r, nom_rbd, cod_reg_rbd, nom_com_rbd, n_mat_teo_total23, desv_total23, porc_total23, n_ret, n_desv, n_dobledesv)
#DESVINCULADOS POR RBD Y CURSO
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% select(rut_sost_rbd2022, rbd_2022r, nom_rbd, cod_reg_rbd, nom_com_rbd, nom_grado, desv_total23, n_ret, n_desv, n_dobledesv)
#Se construye base de datos para resumen por establecimiento.
tbl_desvinc_ee <- xls_desvinc_ee %>% select(rbd_2022r, n_mat_teo_total23, desv_total23, porc_total23, n_ret, n_desv, n_dobledesv)
#tbl_desvinc_ee <- tbl_desvinc_ee %>% rename(n_descinv = desv_total23, n_total_desvinc = n_mat_teo_total23)
tbl_asis_ee <- xsl_asis_ee %>% select(rut_sost_rbd2022, rbd, nom_rbd, nom_com_rbd, asis_marzo,
asis_abril, asis_mayo,
asis_junio, asis_julio, asis_agosto,
asis_septiembre, asis_octubre,
#asis_noviembre,
asis_promedio, n_total, n, porc_asis_crit)
resumen_rbd <- left_join(tbl_asis_ee, tbl_desvinc_ee, by = c("rbd"="rbd_2022r"))
resumen_rbd <- resumen_rbd %>% arrange(nom_rbd)
colnames(resumen_rbd)
(resumen_rbd)
resumen_rbd <- resumen_rbd %>% mutate(asis_marzo = scales::percent(asis_marzo, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(asis_abril = scales::percent(asis_abril, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(asis_mayo = scales::percent(asis_mayo, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(asis_junio = scales::percent(asis_junio, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(asis_julio = scales::percent(asis_julio, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(asis_agosto = scales::percent(asis_agosto, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(asis_septiembre = scales::percent(asis_septiembre, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(asis_octubre = scales::percent(asis_octubre, accuracy = 0.1))
# resumen_rbd <- resumen_rbd %>% mutate(asis_noviembre = scales::percent(asis_noviembre, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(asis_promedio = scales::percent(asis_promedio, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(porc_asis_crit = scales::percent(porc_asis_crit, accuracy = 0.1))
resumen_rbd <- resumen_rbd %>% mutate(porc_total23 = scales::percent(porc_total23, accuracy = 0.1))
# resumen_rbd <- resumen_rbd %>% mutate(porc_ret = scales::percent(porc_ret, accuracy = 0.1))
(resumen_rbd)
# resumen_rbd <- resumen_rbd %>% select(-c(rut_sost_rbd2022))
# resumen_rbd <- left_join(resumen_rbd, bd_rbd_rutsost, by = c("rbd" = "rbd"))
#
# xsl_asis_ee_cur <- xsl_asis_ee_cur %>% select(-c(rut_sost_rbd2022))
# xsl_asis_ee_cur <- left_join(xsl_asis_ee_cur, bd_rbd_rutsost, by = c("rbd" = "rbd"))
#
# xsl_asis_ee <- xsl_asis_ee %>% select(-c(rut_sost_rbd2022))
# xsl_asis_ee <- left_join(xsl_asis_ee, bd_rbd_rutsost, by = c("rbd" = "rbd"))
#
# xls_desvinc_ee <- xls_desvinc_ee %>% select(-c(rut_sost_rbd2022))
# xls_desvinc_ee <- left_join(xls_desvinc_ee, bd_rbd_rutsost, by = c("rbd_2022r" = "rbd"))
#
# xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% select(-c(rut_sost_rbd2022))
# xls_desvinc_ee_cur <- left_join(xls_desvinc_ee_cur, bd_rbd_rutsost, by = c("rbd_2022r" = "rbd"))
# xsl_asis_ee <- xsl_asis_ee %>% mutate_if(is.character, ~gsub('[^ -~]', ' ', .))
# xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate_if(is.character, ~gsub('[^ -~]', ' ', .))
# xls_desvinc_ee <- xls_desvinc_ee %>% mutate_if(is.character, ~gsub('[^ -~]', ' ', .))
# xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate_if(is.character, ~gsub('[^ -~]', ' ', .))
xsl_asis_ee <- xsl_asis_ee %>% mutate_if(is.character, ~gsub('[^\x20-\x7EáéíóúüñÁÉÍÓÚÑÜ]', ' ', .))
xsl_asis_ee_cur <- xsl_asis_ee_cur %>% mutate_if(is.character, ~gsub('[^\x20-\x7EáéíóúüñÁÉÍÓÚÑÜ]', ' ', .))
xls_desvinc_ee <- xls_desvinc_ee %>% mutate_if(is.character, ~gsub('[^\x20-\x7EáéíóúüñÁÉÍÓÚÑÜ]', ' ', .))
xls_desvinc_ee_cur <- xls_desvinc_ee_cur %>% mutate_if(is.character, ~gsub('[^\x20-\x7EáéíóúüñÁÉÍÓÚÑÜ]', ' ', .))
resumen_rbd <- resumen_rbd %>% mutate_if(is.character, ~gsub('[^\x20-\x7EáéíóúüñÁÉÍÓÚÑÜ]', ' ', .))
colnames(resumen_rbd) <- c("rut_sost_rbd2022", "RBD", "Nombre establecimiento", "Comuna", "Asistencia promedio marzo",
"Asistencia promedio abril", "Asistencia promedio mayo",
"Asistencia promedio junio", "Asistencia promedio julio", "Asistencia promedio agosto",
"Asistencia promedio sept.", "Asistencia promedio octubre",
#"Asistencia promedio nov.",
"Asistencia promedio acumulada",
"Matrícula 2023", "N° estud. con asistencia <85%", "% estud. con asistencia <85%", "Matrícula 2023 + estud. sin matrícula", "N° Estud. 2022-2023 sin matricula vigente", "% Estud. 2022-2023 sin matricula vigente", "N° Estud. 2023 retirados en el año y sin matrícula vigente", "N° Estud. 2022 no matriculados en 2023", "Detalle N° Estud. 2021 no matriculados ni en 2022 ni 2023")
#"Matrícula 2023", "N° estudiantes con asistencia <85%", "% estudiantes con asistencia <85%", "Matrícula 2023 + estud. sin matrícula", "N° Estud. 2022-2023 sin matricula vigente", "% Estud. 2022-2023 sin matricula vigente", "Detalle N° Estudiantes 2023 retirados en marzo y que están sin matrícula vigente", "Detalle N° Estudiantes 2022 que no se han matriculado en marzo 2023", "Detalle N° Estudiantes 2021 que no se han matriculado ni en 2022 ni 2023", "rut_sost_rbd2022")
colnames(xsl_asis_ee_cur) <- c("rut_sost_rbd2022","RBD", "Nombre Establecimiento", "Región", "Comuna", "Grado 2023", "Asistencia promedio marzo", "Asistencia promedio abril", "Asistencia promedio mayo",
"Asistencia promedio junio", "Asistencia promedio julio", "Asistencia promedio agosto", "Asistencia promedio septiembre", "Asistencia promedio octubre",
"Asistencia promedio acumulada", "N° Estudiantes totales", "N° estudiantes con asistencia <85%", "% estudiantes con asistencia <85%", "N° Estudiantes con 0-49% asistencia", "N° Estudiantes con 50-84% asistencia",
"N° Estudiantes con 85-89% asistencia", "N° Estudiantes con 90-100% asistencia", "N° Estudiantes sin información", "% Estudiantes con 0-49% asistencia", "% Estudiantes con 50-84% asistencia",
"% Estudiantes con 85-89% asistencia", "% Estudiantes con 90-100% asistencia", "% Estudiantes sin información")
# # "Asistencia promedio abril", "Asistencia promedio mayo", "Asistencia promedio junio","Asistencia promedio julio","Asistencia promedio agosto", "Asistencia promedio septiembre", "Asistencia promedio octubre", "Asistencia promedio noviembre",
# "Asistencia promedio acumulada", "N° Estudiantes totales",
# "N° estudiantes totales con asistencia <85%", "% estudiantes totales con asistencia <85%", "N° Estudiantes con 0-49% asistencia", "N° Estudiantes con 50-84% asistencia",
# "N° Estudiantes con 85-89% asistencia", "N° Estudiantes con 90-100% asistencia",
# #"N° Estudiantes con 85-100% asistencia",
# "N° Estudiantes sin información",
# "% Estudiantes con 0-49% asistencia", "% Estudiantes con 50-84% asistencia",
# "% Estudiantes con 85-89% asistencia", "% Estudiantes con 90-100% asistencia",
# # "% Estudiantes con 85-100% asistencia",
# "rut_sost_rbd2022")
colnames(xsl_asis_ee) <- c("rut_sost_rbd2022", "RBD", "Nombre Establecimiento", "Región", "Comuna", "Asistencia promedio marzo",
"Asistencia promedio abril", "Asistencia promedio mayo",
"Asistencia promedio junio","Asistencia promedio julio","Asistencia promedio agosto",
"Asistencia promedio septiembre", "Asistencia promedio octubre",
#"Asistencia promedio noviembre",
"Asistencia promedio acumulada", "N° Estudiantes totales",  "N° estudiantes con asistencia <85%", "% estudiantes con asistencia <85%", "N° Estudiantes con 0-49% asistencia", "N° Estudiantes con 50-84% asistencia",
"N° Estudiantes con 85-89% asistencia", "N° Estudiantes con 90-100% asistencia", "N° Estudiantes sin información",
"% Estudiantes con 0-49% asistencia", "% Estudiantes con 50-84% asistencia", "% Estudiantes con 85-89% asistencia", "% Estudiantes con 90-100% asistencia", "% Estudiantes sin información")
colnames(xls_desvinc_ee) <- c("rut_sost_rbd2022", "RBD", "Nombre Establecimiento", "Región", "Comuna", "Matrícula 2023 + estudiantes sin matrícula", "N° Estudiantes 2022-2023 sin matricula vigente", "% Estudiantes 2022-2023 sin matrícula vigente", "N° Estudiantes 2023 retirados en el año y sin matrícula vigente", "N° Estudiantes 2022 no matriculados en 2023", "Detalle N° Estudiantes 2021 no matriculados ni en 2022 ni 2023")
colnames(xls_desvinc_ee_cur) <- c("rut_sost_rbd2022", "RBD", "Nombre Establecimiento", "Región", "Comuna", "Último grado registrado", "N° Total Estudiantes sin matricula vigente",
"Detalle N° Estudiantes 2023 retirados en el año y sin matrícula vigente", "Detalle N° Estudiantes 2022 no matriculados en 2023", "Detalle N° Estudiantes 2021 no matriculados ni en 2022 ni 2023")
#**************************************************************************************************************************/
# 3. Loop de Render para cada RBD  ----------------------------------------------------------------
#**************************************************************************************************************************/
## 3.1 Ajuste fuente gráficos  ----------------------------------------------------------------
#**************************************************************************************************************************/
azul <- "1A4672"
celeste <- "74C7D0"
rojo <-  "D35765"
amarillo <- "F4A416"
verde <- "61B798"
blanco <- "FAFAFA"
gris <- "#D8D8D8"
f1 <- list(
family = "verdana",
size = 14,
color = '#004677')
f2 <- list(
family = "verdana",
size = 18,
color = '#004677')
m <- list(
l = 40,
pad = 5
)
f3 <- list(
family = "verdana",
size = 12,
color = '#004677')
f4 <- list(
family = "verdana",
color = '#007096',
size = 17)
m2 <- list(
l = 50,
r = 50,
b = 50,
t = 50,
pad = 3
)
table(bd_asis$cod_curso)
#**************************************************************************************************************************/
## 3.2 Loop  ----------------------------------------------------------------
#**************************************************************************************************************************/
#se arregla nombre con error de estudiante
bd2 <- bd2 %>% mutate(nom_alu_ret = ifelse(run_alu == "100565271", "DJOULISSA", nom_alu_ret))
ruts_sost <- unique(bd_asis$rut_sost_rbd2022)
i = 0
nn = length(ruts_sost)
nn
df <- data.frame(rbd = ruts_sost )
archivos <- list.files("D:\\Downloads\\WorkDocsDownloads\\sostenedores_nov_2023")
pdfs <- data.frame(nombre_pdf = archivos)
head(pdfs)
pdfs <- pdfs%>% filter(!grepl(".tex", nombre_pdf, fixed = TRUE))
pdfs <- pdfs%>% filter(!grepl(".xlsx", nombre_pdf, fixed = TRUE))
colnames(pdfs)
pdfs <- pdfs %>% filter(nombre_pdf != "NA.pdf") %>% mutate(rbd = gsub(".pdf", "", nombre_pdf)) %>% mutate(rbd = as.numeric(rbd))
#(pdfs)
head(pdfs)
nrow(pdfs)
df <- left_join(df, pdfs, by = "rbd")
errores <- df %>% filter(is.na(nombre_pdf))
errores <- unique(errores$rbd)
errores <- errores[!is.na(errores)]
errores
length(errores)
df <- data.frame(rbd = ruts_sost )
nrow(df)
archivos <- list.files("D:\\Downloads\\WorkDocsDownloads\\sostenedores_nov_2023")
pdfs <- data.frame(nombre_pdf = archivos)
head(pdfs)
colnames(pdfs)
pdfs <- pdfs %>% filter(nombre_pdf != "NA.xlsx") %>%
mutate(rbd = gsub(".xlsx", "", nombre_pdf)) %>%
mutate(rbd = as.numeric(rbd))
#(pdfs)
head(pdfs)
nrow(pdfs)
df <- left_join(df, pdfs, by = "rbd")
errores <- df %>% filter(is.na(nombre_pdf))
errores <- unique(errores$rbd)
errores <- errores[!is.na(errores)]
errores
length(errores)

data_plot6_t <- asis_crit %>% group_by(rut_sost_rbd2022) %>% summarise(n = n()) %>% ungroup()
data_plot6  <- left_join(data_plot6, data_plot6_t, by=c("rut_sost_rbd2022"))
data_plot6  <- data_plot6 %>% mutate(n = ifelse(is.na(n), 0, n))
data_plot6  <- data_plot6 %>% mutate(n_total = ifelse(is.na(n_total), 0, n_total))
data_plot6 <- data_plot6 %>% mutate(porc_asiscrit = ifelse(n_total != 0, 100*round(n/n_total, 3), 0))
data_plot6 <- data_plot6 %>% arrange(porc_asiscrit)
#data_plot6$nom_rbd <- factor(data_plot6$nom_rbd, levels = data_plot6$nom_rbd)
data_plot6$nom_rbd <- paste0(data_plot6$nom_rbd, " (RBD: ", data_plot6$rbd,")")
#data_plot6$cod_depe2 <- factor(data_plot6$cod_depe2, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
q <- plot_ly() %>% add_trace(x = ~data_plot6$porc_asiscrit, y = ~data_plot6$nombre_sost_rbd2022,  marker = list(color = "#6bccd6"), type = "bar", orientation = "h", text = paste0("<b style='color:#007096'>", data_plot6$porc_asiscrit, "%","</b>", "<i style='color:#007096';> (", data_plot6$n," de ", data_plot6$n_total,")</i>"), textposition = "outside", textfont = list(family = "verdana", color = '#FFFFFF'))
if(nrow(data_plot6) < 4){  #Si son pocos EE se achican las barras
q <- q %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "", bargap = 0.8,
#xaxis2 = list(title="<b>% Estudiantes con asistencia grave 2023</b>", font = list(family = "verdana", size = 8, color = "#e94860"), side = "top",
#             overlaying = "x", position=1,  range = list(0, max(data_plot6$porc_asiscrit) + 10), showgrid = FALSE, zeroline = FALSE,
#            tickfont = list(color = "#e94860"), ticksuffix = "%", titlefont = list(color = "#e94860")),
xaxis = list(title="<b>% estud. con asistencia bajo 85%</b> <i> (N° estud. sobre matrícula 2023)</i>", font = list(family = "verdana", size = 16), range = list(0, max(data_plot6$porc_asiscrit) + 26), showlegend = FALSE, ticksuffix = "%", showgrid = FALSE, side = "top"),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 18), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
} else if(nrow(data_plot6) > 35 & nrow(data_plot6) < 66){
q <- q %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "",
#xaxis2 = list(title="<b>% Estudiantes con asistencia grave 2023</b>", font = list(family = "verdana", size = 8, color = "#e94860"), side = "top",
#             overlaying = "x", position=1,  range = list(0, max(data_plot6$porc_asiscrit) + 10), showgrid = FALSE, zeroline = FALSE,
#            tickfont = list(color = "#e94860"), ticksuffix = "%", titlefont = list(color = "#e94860")),
xaxis = list(title="<b>% estud. con asistencia bajo 85%</b> <i> (N° estud. sobre matrícula 2023)</i>", font = list(family = "verdana", size = 16), range = list(0,  max(data_plot6$porc_asiscrit) + 26), showlegend = FALSE, ticksuffix = "%", showgrid = FALSE, side = "top"),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.15)
)
} else if(nrow(data_plot6) >= 66){
q <- q %>% layout(font = list(family = "verdana", color = '#007096', size = 16), title = "",
#xaxis2 = list(title="<b>% Estudiantes con asistencia grave 2023</b>", font = list(family = "verdana", size = 8, color = "#e94860"), side = "top",
#             overlaying = "x", position=1,  range = list(0, max(data_plot6$porc_asiscrit) + 10), showgrid = FALSE, zeroline = FALSE,
#            tickfont = list(color = "#e94860"), ticksuffix = "%", titlefont = list(color = "#e94860")),
xaxis = list(title="<b>% estud. con asistencia bajo 85%</b> <i> (N° estud. sobre matrícula 2023)</i>", font = list(family = "verdana", size = 14), range = list(0,  max(data_plot6$porc_asiscrit) + 26), showlegend = FALSE, ticksuffix = "%", showgrid = FALSE, side = "top"),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.15)
)
} else{
q <- q %>% layout(font = list(family = "verdana", color = '#007096', size = 16), title = "",
#xaxis2 = list(title="<b>% Estudiantes con asistencia grave 2023</b>", font = list(family = "verdana", size = 8, color = "#e94860"), side = "top",
#             overlaying = "x", position=1,  range = list(0, max(data_plot6$porc_asiscrit) + 10), showgrid = FALSE, zeroline = FALSE,
#            tickfont = list(color = "#e94860"), ticksuffix = "%", titlefont = list(color = "#e94860")),
xaxis = list(title="<b>% estud. con asistencia bajo 85%</b> <i> (N° estud. sobre matrícula 2023)</i>", font = list(family = "verdana", size = 16), range = list(0,  max(data_plot6$porc_asiscrit) + 26), showlegend = FALSE, ticksuffix = "%", showgrid = FALSE, side = "top"),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.15)
)
}
# url_sost_asisgrave_g = paste0("/Img temp/", "dep","_sost_asisgrave_g.png")
# orca(q, url_sost_asisgrave_g)
url_sost_asisgrave_g = paste0(getwd(),"/Img temp/", "dep","_sost_asisgrave_g.png")
save_image(q, url_sost_asisgrave_g)
# #**************************************************************************************************************************/
# ## 3.2 RENDER  ----------------------------------------------------------------
# #**************************************************************************************************************************/
#
rmarkdown::render("Codigos/5 - DEP/RMKD Informe DEP (EPJA).Rmd",
params = list("cod_deprov" = rut_sost, "nom_deprov" = nom_sost, "desvinc" = desvinc, "desvinc2" = desvinc2, "desvinc3" = desvinc3, "asis_crit" = asis_crit, "url_sin_fin_g" = url_sin_fin_g, "url_cur_desv_g" = url_cur_desv_g, "url_asis_crit_g" = url_asis_crit_g, "url_sost_desv_g" = url_sost_desv_g, "url_sost_desv_g_2" = url_sost_desv_g_2, "url_cur_desv_g_2" = url_cur_desv_g_2, "url_sost_asist_g" = url_sost_asist_g,
"url_sost_asisgrave_g" = url_sost_asisgrave_g, "n_mat2022" = n_mat2022, "n_desvinc" = n_desvinc, "n_desvinc2" = n_desvinc2, "n_desvinc3" = n_desvinc3, "n_mat2023" = n_mat2023, "n_mat_asis2023" = n_mat_asis2023, "n_inasis2023" = n_inasis2023, "textos_variables_desvinculados" = textos_variables_desvinculados, "textos_variables_retirados" = textos_variables_retirados, "textos_variables_asistencia" = textos_variables_asistencia, "textos_variables_doble_desvinculados" = textos_variables_doble_desvinculados, "pass" = pass, "resumen_asis_sost" = resumen_asis_sost, "resumen_desvinc_sost" = resumen_desvinc_sost, "resumen_rbd" = resumen_rbd_ee),
output_file = paste0("Outputs/DEP/", "DEP (EPJA)", ".pdf"))
print(paste0("Listo ", i ," de ", nn, " Sost. (Codigo: ", "DEP", ")"))
#**************************************************************************************************************************/
## 3.3 EXCEL DEPROV  ----------------------------------------------------------------
#**************************************************************************************************************************/
#*
xsl_asis_ee_deprov <- xsl_asis_ee %>% filter(rut_sost_rbd2022 %in% rut_sost) %>% select(-c(rut_sost_rbd2022))
xsl_asis_ee_cur_deprov <- xsl_asis_ee_cur %>% filter(rut_sost_rbd2022 %in% rut_sost) %>% select(-c(rut_sost_rbd2022))
xls_desvinc_ee_deprov <- xls_desvinc_ee %>% filter(rut_sost_rbd2022 %in% rut_sost) %>% select(-c(rut_sost_rbd2022))
xls_desvinc_ee_cur_deprov <- xls_desvinc_ee_cur %>% filter(rut_sost_rbd2022 %in% rut_sost) %>% select(-c(rut_sost_rbd2022))
resumen_rbd_aux <- resumen_rbd %>% rename("Rut SLEP" = rut_sost_rbd2022)
desvinc0 <- desvinc %>% select("rbd_2022r", "nom_rbd_2022r", "run_alu2", "nom_alu2022", "app_alu2022", "apm_alu2022", "nom_grado", "edad_alu_2022r", "gen_alu_2022r", "nom_com_alu2022", "sit_fin_r_2022r", "cert_val_22", "valid_estud")
colnames(desvinc0) <- c("RBD", "Nombre Establecimiento", "RUN", "Nombre", "Apellido Parteno", "Apellido Materno", "Grado en 2022", "Edad 2022", "Sexo", "Comuna de residencia 2022", "Situación final 2022", "Validó estudios en 2022", "Inscrita/o para examen de validación 2023")
desvinc2_0 <- desvinc2 %>% select("rbd_ret", "nom_rbd_ret", "run_alu2_ret", "nom_alu_ret", "app_alu_ret", "apm_alu_ret", "nom_grado_ret", "edad_alu_ret", "gen_alu_ret", "nom_com_alu_ret", "fec_ret_rbd_ret", "valid_estud")
colnames(desvinc2_0) <- c("RBD", "Nombre Establecimiento", "RUN", "Nombre", "Apellido Parteno", "Apellido Materno","Grado en 2023", "Edad", "Sexo","Comuna de residencia 2023", "Fecha de retiro", "Inscrita/o para examen de validación 2023")
desvinc3_0 <- desvinc3 %>% select("rbd", "nom_rbd", "run_alu2", "nom_alu", "app_alu", "apm_alu", "nom_grado", "edad_alu", "gen_alu", "nom_com_alu", "sit_fin_r", "cert_val_21", "cert_val_22", "insc_val_23")
colnames(desvinc3_0) <- c("RBD", "Nombre Establecimiento", "RUN", "Nombre", "Apellido Parteno", "Apellido Materno", "Grado en 2021", "Edad 2021", "Sexo", "Comuna de residencia 2021", "Situación final 2021", "Validó estudios en 2021", "Validó estudios en 2022", "Inscrita/o para examen de validación 2023")
wb <- createWorkbook()
addWorksheet(wb, sheetName = "Resumen datos SLEP")
addWorksheet(wb, sheetName = "Nómina estud. retirados 2023")
addWorksheet(wb, sheetName = "Nómina estud. no matric 22-23")
addWorksheet(wb, sheetName = "Nómina estud. no matric 21-23")
addWorksheet(wb, sheetName = "Resumen no matric x RBD")
addWorksheet(wb, sheetName = "Resumen no matric x RBD y grado")
addWorksheet(wb, sheetName = "Resumen asist x RBD")
addWorksheet(wb, sheetName = "Resumen asist x RBD y grado")
writeData(wb, "Resumen datos SLEP", resumen_rbd_aux)
writeData(wb, "Nómina estud. retirados 2023", desvinc2_0)
writeData(wb, "Nómina estud. no matric 22-23", desvinc0)
writeData(wb, "Nómina estud. no matric 21-23", desvinc3_0)
writeData(wb, "Resumen no matric x RBD", xls_desvinc_ee_deprov)
writeData(wb, "Resumen no matric x RBD y grado", xls_desvinc_ee_cur_deprov)
writeData(wb, "Resumen asist x RBD", xsl_asis_ee_deprov)
writeData(wb, "Resumen asist x RBD y grado", xsl_asis_ee_cur_deprov)
pct = createStyle(numFmt="0.0%")
#addStyle(wb, "Resumen datos SLEP", style=pct, cols=c(2,3,6, 12:15, 18), rows=2:(nrow(resumen_rbd)+1), gridExpand=TRUE)
addStyle(wb, "Resumen datos SLEP", style=pct, cols=c(3:9,12, 18:22, 25), rows=2:(nrow(resumen_rbd)+1), gridExpand=TRUE)
addStyle(wb, "Resumen no matric x RBD", style=pct, cols=c(8), rows=2:(nrow(xls_desvinc_ee_deprov)+1), gridExpand=TRUE)
# addStyle(wb, "Resumen no matric x RBD y grado", style=pct, cols=c(8), rows=2:(nrow(xls_desvinc_ee_cur_deprov)+1), gridExpand=TRUE)
addStyle(wb, "Resumen asist x RBD", style=pct, cols=c(6:12, 15, 21:25), rows=2:(nrow(xsl_asis_ee_deprov)+1), gridExpand=TRUE)
addStyle(wb, "Resumen asist x RBD y grado", style=pct, cols=c(7:13, 16, 22:27), rows=2:(nrow(xsl_asis_ee_cur_deprov)+1), gridExpand=TRUE)
saveWorkbook(wb, paste0("Outputs/DEP/", "DEP", " (EPJA).xlsx"), overwrite = T)
toc()
}
{
slep <- c(62000660, 62000810, 61999330, 61999320, 62000820, 62000790, 65181672, 65154272, 62000800, 62000650, 65154021)
rut_sost = slep
####### RUN ----
tic()
#**************************************************************************************************************************/
## 3.1 PRE RENDER  ----------------------------------------------------------------
#**************************************************************************************************************************/
#i = i+1
pass <- "dep2023cem3"
########## SE COMIENZA CON DESVINCULADOS
#desvinc <- bd[bd$rut_sost_rbd2022 == rut_sost,]
desvinc <- bd[bd$rut_sost_rbd2022 %in% rut_sost,]
nrow(desvinc)
data_plot2 <- data.frame(nom_grado = unique(desvinc$nom_grado))
data_plot4 <- data_plot4_n %>% filter(rut_sost_rbd2022 %in% unique(desvinc$rut_sost_rbd2022))
n_mat2022 <- nrow(desvinc)
# Dejamos solo estudiantes desertores en mayo y por si acaso se filtra fallecidos, aunque ya vienen como deserción == 0
desvinc <- desvinc %>% filter(categoria_desert == "Desercion incidencia")    #(desert_glob_total_aju_marzo_2023 == 1 & fallece_tot == 0)
desvinc2 <- bd2[bd2$rut_sost_rbd2022_ret %in% rut_sost,]
desvinc2 <- desvinc2 %>% filter(categoria_desert == "Retirado 2023")
desvinc3 <- doble_desvinc[doble_desvinc$rut_sost_rbd2022 %in% rut_sost,]
# n_desvinc <- nrow(desvinc)
# n_desvinc2 <- nrow(desvinc2)
# n_desvinc3 <- nrow(desvinc3)
n_desvinc <- xls_desvinc_ee[xls_desvinc_ee$rut_sost_rbd2022 %in% rut_sost,]
n_desvinc = sum(n_desvinc$`N° Estudiantes 2022 no matriculados en 2023`, na.rm = T) # nrow(desvinc2)
n_desvinc2 <- xls_desvinc_ee[xls_desvinc_ee$rut_sost_rbd2022 %in% rut_sost,]
n_desvinc2 = sum(n_desvinc2$`N° Estudiantes 2023 retirados en el año y sin matrícula vigente`, na.rm = T) # nrow(desvinc2)
n_desvinc3 <- xls_desvinc_ee[xls_desvinc_ee$rut_sost_rbd2022 %in% rut_sost,]
n_desvinc3 = sum(n_desvinc3$`Detalle N° Estudiantes 2021 no matriculados ni en 2022 ni 2023`, na.rm = T) # nrow(desvinc2)
desvinc <- desvinc %>% select("run_alu2", "nom_alu2022", "app_alu2022", "apm_alu2022", "gen_alu_2022r", "edad_alu_2022r", "nom_com_alu2022", "nom_grado", "prom_gral2022", "asistencia2022", "sit_fin_r_2022r",
"rbd_2022r", "nom_rbd_2022r", "cod_depe2_2022r", "cod_reg_rbd2022r2", "cod_com_rbd_2022r", "nom_com_rbd_2022r", "cod_deprov_rbd2022", "nom_deprov_rbd2022", "nombre_sost_rbd2022", "rut_sost_rbd2022", "email_sost_rbd2022",  "tel_sost_rbd", "cert_val_22", "valid_estud")
desvinc <- desvinc %>% arrange(nom_rbd_2022r, nom_grado)
# desvinc2 <- desvinc2 %>% select("run_alu2_ret", "nom_alu_ret", "app_alu_ret", "apm_alu_ret", "gen_alu_ret", "edad_alu_ret", "nom_com_alu_ret", "nom_grado", "fec_ret_rbd_ret", "valid_estud")
# colnames(desvinc2)
desvinc2 <- desvinc2 %>% select("run_alu2_ret", "nom_alu_ret", "app_alu_ret", "apm_alu_ret", "gen_alu_ret", "edad_alu_ret", "nom_com_alu_ret", "nom_grado_ret", "fec_ret_rbd_ret", "valid_estud",
"rbd_ret", "nom_rbd_ret", "cod_depe2_ret", "cod_reg_rbd_ret", "cod_com_rbd_ret", "nom_com_rbd_ret", "cod_deprov_rbd_ret", "rut_sost_rbd2022_ret", "nombre_sost_rbd2022")
desvinc2 <- desvinc2 %>% arrange(nombre_sost_rbd2022, nom_grado_ret)
desvinc3 <- desvinc3 %>% select("run_alu2", "nom_alu", "app_alu", "apm_alu", "gen_alu", "edad_alu", "nom_com_alu", "nom_grado", "sit_fin_r", "rbd", "nom_rbd", "cod_depe2", "cod_reg_rbd", "nom_com_rbd", "cert_val_21", "cert_val_22", "insc_val_23") # cert vald 21? muchos vacios
desvinc3 <- desvinc3 %>% arrange(nom_rbd, nom_grado)
########## SE EXTRAEN LOS CASOS DE INASISTENCIA Y PARAMETROS
asis_crit <- bd_asis[bd_asis$rut_sost_rbd2022 %in% rut_sost,]
data_plot2_2 <- data.frame(nom_grado = unique(asis_crit$nom_grado))
#data_plot4_2 <- data_plot4_n_2 %>% filter(nom_rbd %in% unique(asis_crit$nom_rbd)) #data.frame(nom_rbd2022r = unique(desvinc$nom_rbd2022r))
data_plot4_2 <- data_plot4_n_2 %>% filter(rut_sost_rbd2022 %in% unique(asis_crit$rut_sost_rbd2022))
data_plot3 <- data.frame(cod_curso = unique(asis_crit$cod_curso))
data_plot3_n <- asis_crit %>% group_by(cod_curso) %>% summarise(n_total = n())
#data_plot6 <- data_plot6_n %>% filter(nom_rbd %in% unique(asis_crit$nom_rbd))
data_plot6 <- data_plot6_n %>% filter(rut_sost_rbd2022 %in% unique(asis_crit$rut_sost_rbd2022))
#nom_rbd <- asis_crit$nom_rbd[1]
nom_sost <- asis_crit$nombre_sost_rbd2022[1]
#nom_deprov <- asis_crit$cod_reg_rbd2022r2[1]
###PRUEBA
# n_mat2023 = nrow(bd_asis_todos[bd_asis_todos$cod_reg_rbd == cod_reg,])
n_mat2023 = xls_desvinc_ee[xls_desvinc_ee$rut_sost_rbd2022 %in% rut_sost,] #nrow(asis_crit)
n_mat2023 = sum(n_mat2023$`Matrícula 2023 + estudiantes sin matrícula`, na.rm = T) #nrow(xls_desvinc_ee[xls_desvinc_ee$cod_reg_rbd2022r2 == cod_reg | xls_desvinc_ee$cod_reg_rbd_ret  == cod_reg,]) #+ nrow(desvinc2)
#
#
#n_mat2023 = nrow(asis_crit)
n_mat_asis2023 = xsl_asis_ee[xsl_asis_ee$rut_sost_rbd2022 %in% rut_sost,] #nrow(asis_crit)
n_mat_asis2023 = sum(n_mat_asis2023$`N° Estudiantes totales`, na.rm = T) #nrow(xls_desvinc_ee[xls_desvinc_ee$cod_reg_rbd2022r2 == cod_reg | xls_desvinc_ee$cod_reg_rbd_ret  == cod_reg,]) #+ nrow(desvinc2)
print("-----")
print(nom_sost)
print(rut_sost)
#BD resumen EE
resumen_asis_sost <- resumen_asis_ee %>% filter(rut_sost_rbd2022 %in% rut_sost)
resumen_asis_sost <- resumen_asis_sost %>% select(rut_sost_rbd2022, nombre_sost_rbd2022, asis_promedio, asis_marzo,
asis_abril, asis_mayo,
asis_junio, asis_julio, asis_agosto,
asis_septiembre, asis_octubre,
#asis_noviembre,
#n_total, n, porc_asis_crit, porc1, porc2, porc3, porc4, porc5)
n_total, n, porc_asis_crit, porc1, porc2, porc3, porc4, sin_info)
resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_marzo = paste0(round(asis_marzo*100, 1),"%"))
resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_abril = paste0(round(asis_abril*100, 1),"%"))
resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_mayo = paste0(round(asis_mayo*100, 1),"%"))
resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_junio = paste0(round(asis_junio*100, 1),"%"))
resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_julio = paste0(round(asis_julio*100, 1),"%"))
resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_agosto = paste0(round(asis_agosto*100, 1),"%"))
resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_septiembre = paste0(round(asis_septiembre*100, 1),"%"))
resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_octubre = paste0(round(asis_octubre*100, 1),"%"))
# resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_noviembre = paste0(round(asis_noviembre*100, 1),"%"))
resumen_asis_sost <- resumen_asis_sost %>% mutate(asis_promedio = paste0(round(asis_promedio*100, 1),"%"))
resumen_asis_sost <- resumen_asis_sost %>% mutate(porc_asis_crit = paste0(round(porc_asis_crit*100, 1),"%"))
# resumen_asis_sost <- resumen_asis_sost %>% mutate(porc1 = ifelse(!is.na(`1`), paste0(100*round(`1`/n_total2, 3),"%"), "0%"))
# resumen_asis_sost <- resumen_asis_sost %>% mutate(porc2 = ifelse(!is.na(`2`), paste0(100*round(`2`/n_total2, 3),"%"), "0%"))
# resumen_asis_sost <- resumen_asis_sost %>% mutate(porc3 = ifelse(!is.na(`3`), paste0(100*round(`3`/n_total2, 3),"%"), "0%"))
# resumen_asis_sost <- resumen_asis_sost %>% mutate(porc4 = ifelse(!is.na(`4`), paste0(100*round(`4`/n_total2, 3),"%"), "0%"))
# resumen_asis_sost <- resumen_asis_sost %>% mutate(sin_info = ifelse(!is.na(`NA`), paste0(100*round(`NA`/n_total2, 3),"%"), NA))
#
#resumen_asis_sost$cod_depe2 <- factor(resumen_asis_sost$cod_depe2, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
print("hola")
resumen_rbd_ee <- resumen_rbd %>% filter(rut_sost_rbd2022 %in% rut_sost)
# print("chasaaao")
resumen_rbd_ee <- resumen_rbd_ee %>% select(-c("rut_sost_rbd2022"))
#resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_marzo = paste0(round(asis_marzo*100, 1),"%"))
# resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_abril = paste0(round(asis_abril*100, 1),"%"))
# resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_mayo = paste0(round(asis_mayo*100, 1),"%"))
# resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_junio = paste0(round(asis_junio*100, 1),"%"))
# resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_julio = paste0(round(asis_julio*100, 1),"%"))
# resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_agosto = paste0(round(asis_agosto*100, 1),"%"))
# resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_septiembre = paste0(round(asis_septiembre*100, 1),"%"))
# resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_octubre = paste0(round(asis_octubre*100, 1),"%"))
# resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_noviembre = paste0(round(asis_noviembre*100, 1),"%"))
#resumen_rbd_ee <- resumen_rbd_ee %>% mutate(asis_promedio = paste0(round(asis_promedio*100, 1),"%"))
#resumen_rbd_ee <- resumen_rbd_ee %>% mutate(porc_asis_crit = paste0(round(porc_asis_crit*100, 1),"%"))
# print("chao")
print(resumen_asis_sost)
print("-----")
resumen_desvinc_sost <- resumen_desvinc_ee %>% filter(rut_sost_rbd2022 %in% rut_sost)# & (n_desv > 0 | n_ret > 0))
print(resumen_desvinc_sost)
print("***")
#Datos gráfico de barra de rangos de asistencia
data_plot5 <- data.frame(tipo_asis_2 = c("Inasist. crítica (0%-49% asist.)", "Inasist. grave (50%-84% asist.)", "Inasist. reiterada (85%-89% asist.)", "Asist. esperada (90%-100% asist.)", "Sin información"), color = c(rojo, amarillo, celeste, azul, gris))
data_plot5$tipo_asis_2 <- factor(data_plot5$tipo_asis_2, levels = c("Inasist. crítica (0%-49% asist.)", "Inasist. grave (50%-84% asist.)","Inasist. reiterada (85%-89% asist.)", "Asist. esperada (90%-100% asist.)", "Sin información"), labels =  c("Inasist. crítica (0%-49% asist.)", "Inasist. grave (50%-84% asist.)", "Inasist. reiterada (85%-89% asist.)", "Asist. esperada (90%-100% asist.)", "Sin información"))
data_plot5$tipo_asis_2
table(asis_crit$tipo_asis_2)
if(nrow(asis_crit) > 0){
data_plot5_t <- prop.table(table(asis_crit$tipo_asis_2))
data_plot5_t <- data.frame("tipo_asis_2"=names(data_plot5_t), "prop" = as.numeric(data_plot5_t))
} else{
data_plot5_t <- data.frame(tipo_asis_2= c("Inasist. crítica (0%-49% asist.)", "Inasist. grave (50%-84% asist.)", "Inasist. reiterada (85%-89% asist.)", "Asist. esperada (90%-100% asist.)", "Sin información"), prop = c(0,0,0,0,0))
}
data_plot5_t
data_plot5 <- left_join(data_plot5, data_plot5_t, by = "tipo_asis_2")
data_plot5 <- data_plot5 %>% mutate(prop = ifelse(is.na(prop), 0 , prop))
#----
asis_crit <- asis_crit %>% filter(inasistencia_grave_acumulada == TRUE) # | tipo_asis_2 == "Sin información")
n_inasis2023 = nrow(asis_crit)
asis_crit <- asis_crit %>% select("rut_sost_rbd2022","nombre_sost_rbd2022", "run_alu", "nom_alu", "app_alu", "apm_alu", "cod_curso", "rbd", "nom_rbd", "nom_com_rbd", "nom_reg_rbd_a", "porcentage_asistencia_acumulada", "inasistencia_grave_acumulada", "asistencia_categorias_acumulada", "tipo_asis_2")
asis_crit <- asis_crit %>% arrange(nom_rbd, cod_curso, porcentage_asistencia_acumulada)
nrow(asis_crit)
asis_crit <- asis_crit %>% mutate(porcentage_asistencia_acumulada = paste0(round(porcentage_asistencia_acumulada*100,0),"%"))
######  GRAFICO TORTA SIT_FIN
######
#data_plot1 <- data.frame(sit_fin_r_2022r = c("Promovido", "Reprobado", "Retirado"), color = c('#004677', '#6bccd6', '#e94860'))
#data_plot1$sit_fin_r_2022r <- factor(data_plot1$sit_fin_r_2022r, levels =  c("Promovido", "Reprobado", "Retirado"), labels =  c("Promovido", "Reprobado", "Retirado"))
data_plot1 <- data.frame(sit_fin_r_2022r = c("Promovido", "Reprobado", "Retirado", "Sin Registro"), color = c('#004677', '#6bccd6', '#e94860', '#e4db89'))
data_plot1$sit_fin_r_2022r <- factor(data_plot1$sit_fin_r_2022r, levels =  c("Promovido", "Reprobado", "Retirado", "Sin Registro"), labels =  c("Promovido", "Reprobado", "Retirado", "Sin Registro"))
if(nrow(desvinc) > 0){
data_plot1_t <- prop.table(table(desvinc$sit_fin_r_2022r))
data_plot1_t <- data.frame("sit_fin_r_2022r"=names(data_plot1_t), "prop" = as.numeric(data_plot1_t))
} else{
#data_plot1_t <- data.frame(sit_fin_r_2022r= c("Promovido", "Reprobado", "Retirado"), prop = c(0,0,0))
data_plot1_t <- data.frame(sit_fin_r_2022r= c("Promovido", "Reprobado", "Retirado", "Sin Registro"), prop = c(0,0,0,0))
}
data_plot1 <- left_join(data_plot1, data_plot1_t, by = "sit_fin_r_2022r")
data_plot1 <- data_plot1 %>% mutate(prop = ifelse(is.na(prop), 0 , prop))
########## GRAFICO TORTA SIT_FIN
p <- plot_ly(data_plot1, labels = ~sit_fin_r_2022r, values = ~round(prop,3), type = 'pie', hole = 0, textposition = 'outside',
textinfo = 'label+percent', marker = list(colors = ~color)) %>%
layout(legend = list(font = f2, orientation = "h", x=0.1 , y=1.6), font=f2, xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
paper_bgcolor='transparent', autosize = TRUE
)
#
# url_sin_fin_g = paste0("/Img temp/","dep","_sit_fin_g.png")
# orca(p, url_sin_fin_g)
url_sin_fin_g = paste0(getwd(),"/Img temp/","dep","_sit_fin_g.png")
save_image(p,url_sin_fin_g)
########## GRAFICO BARRA CURSO DESVINC
data_plot2 <- data_plot2 %>% arrange(nom_grado)
data_plot2_t <- desvinc %>% group_by(nom_grado) %>% summarise(n = n())
data_plot2  <- left_join(data_plot2, data_plot2_t, by="nom_grado")
data_plot2  <- data_plot2 %>% mutate(n = ifelse(is.na(n), 0, n))
data_plot2 <- data_plot2 %>% droplevels()
k <- plot_ly(x = ~data_plot2$nom_grado, y = ~data_plot2$n , type = "bar", marker = list(color = '#6bccd6'), text = data_plot2$n, texttemplate = '%{y}', textposition = 'outside') %>%
layout(title="", xaxis=list(font = list(family = "verdana", color = '#007096', size = 20), title='<b>Grado 2022</b>'), yaxis=list(font = f4, title="<b>N° Estudiantes</b>", autotick = T),
font=list(family = "verdana", color = '#007096', size = 20), plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1400, height = 900, margin = list(l=-0.1, t = -0.1, r=-0.1))
# url_cur_desv_g = paste0("/Img temp/", "dep","_cur_desv_g.png")
# orca(k, url_cur_desv_g)
url_cur_desv_g = paste0(getwd(),"/Img temp/", "dep","_cur_desv_g.png")
save_image(k, url_cur_desv_g)
########## GRAFICO BARRA CURSO RETIRADOS
data_plot2_2 <- data_plot2_2 %>% arrange(nom_grado)
data_plot2_t_2 <- desvinc2 %>% group_by(nom_grado_ret) %>% summarise(n = n())
data_plot2_2  <- left_join(data_plot2_2, data_plot2_t_2, by=c("nom_grado"="nom_grado_ret"))
data_plot2_2  <- data_plot2_2 %>% mutate(n = ifelse(is.na(n), 0, n))
data_plot2_2 <- data_plot2_2 %>% droplevels()
k2 <- plot_ly(x = ~data_plot2_2$nom_grado, y = ~data_plot2_2$n , type = "bar", marker = list(color = '#6bccd6'), text = data_plot2_2$n, texttemplate = '%{y}', textposition = 'outside') %>%
layout(title="", xaxis=list(font = list(family = "verdana", color = '#007096', size = 20), title='<b>Grado 2023</b>'), yaxis=list(font = f4, title="<b>N° Estudiantes</b>", autotick = T),
font=list(family = "verdana", color = '#007096', size = 20), plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1400, height = 900, margin = list(l=-0.1, t = -0.1, r=-0.1))
# url_cur_desv_g_2 = paste0("/Img temp/", "dep","_cur_desv_g_2.png")
# orca(k2, url_cur_desv_g_2)
url_cur_desv_g_2 = paste0(getwd(),"/Img temp/", "dep","_cur_desv_g_2.png")
save_image(k2, url_cur_desv_g_2)
########## GRAFICO BARRA INASISTENCIA GRAVE
data_plot3 <- data_plot3 %>% arrange(cod_curso)
data_plot3_t <- asis_crit %>% group_by(cod_curso) %>% summarise(n = n())
data_plot3  <- left_join(data_plot3, data_plot3_t, by="cod_curso")
data_plot3  <- left_join(data_plot3, data_plot3_n, by="cod_curso")
data_plot3  <- data_plot3 %>% mutate(n = ifelse(is.na(n), 0, n))
data_plot3  <- data_plot3 %>% mutate(n_total = ifelse(is.na(n_total), 0, n_total))
data_plot3  <- data_plot3 %>% mutate(porc_asiscrit = ifelse(n_total > 0, round(100*n/n_total,0), 0))
data_plot3 <- data_plot3 %>% droplevels()
#data_plot3  <- data_plot3 %>% mutate(porc_asiscrit = paste0(porc_asiscrit, "%"))
j <- plot_ly(x=~data_plot3$cod_curso, y = ~data_plot3$porc_asiscrit , type = "bar", marker = list(color = '#6bccd6'), text = data_plot3$n, texttemplate = '%{y}', textposition = 'outside') %>%
layout(title="", xaxis=list(font = list(family = "verdana", color = '#007096', size = 20), title='<b>Grado 2023</b>'), yaxis=list(font = list(family = "verdana", color = '#007096', size = 17), title="<b>% Estudiantes</b>", autotick = T, ticksuffix = "%"),
font=list(family = "verdana", color = '#007096', size = 20), plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1400, height = 900, margin = list(l=-0.1, t = -0.1, r=-0.1))
# url_asis_crit_g = paste0("/Img temp/", "dep","_asis_crit_g.png")
# orca(j, url_asis_crit_g)
url_asis_crit_g = paste0(getwd(),"/Img temp/", "dep","_asis_crit_g.png")
save_image(j, url_asis_crit_g)
########## GRAFICO BARRA DESVINCULADOS POR Dependencia.
data_plot4_t <- desvinc %>% group_by(rut_sost_rbd2022) %>% summarise(n = n())
print(data_plot4)
print(data_plot4_t)
data_plot4  <- left_join(data_plot4, data_plot4_t, by=c("rut_sost_rbd2022"))
data_plot4  <- data_plot4 %>% mutate(n = ifelse(is.na(n), 0, n))
#data_plot4 <- data_plot4 %>% arrange(desc(n))
#data_plot4  <- left_join(data_plot4, data_plot4_n, by="nom_rbd2022r")
data_plot4  <- data_plot4 %>% mutate(n_total = ifelse(is.na(n_total), 0, n_total))
data_plot4 <- data_plot4 %>% mutate(porc_desvinc = ifelse(n_total != 0, 100*round(n/n_total, 3), 0))
data_plot4 <- data_plot4 %>% arrange(n)
#data_plot4$nom_rbd_2022r <- paste0(data_plot4$nom_rbd_2022r, " (RBD: ", data_plot4$rbd_2022r,")")
#data_plot4$nom_rbd2022r <- factor(data_plot4$nom_rbd2022r, levels = data_plot4$nom_rbd2022r)
#data_plot4$nom_rbd_2022r <- paste0(data_plot4$nom_rbd_2022r, " (RBD: ", data_plot4$rbd_2022r,")")
# data_plot4$cod_depe2_2022r <- factor(data_plot4$cod_depe2_2022r, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
m <- plot_ly() %>% add_trace(x = ~data_plot4$n, y = ~data_plot4$nombre_sost_rbd2022, marker = list(color = "#6bccd6"), type = "bar", orientation = "h", text = paste0("<b style='color:#007096'>",data_plot4$n,"</b>", "<i style='color:#007096';> (", data_plot4$porc_desvinc,"%)</i>"), textposition = "outside", textfont = list(family = "verdana", color = '#FFFFFF'))
if(nrow(data_plot4) < 4){
m <- m %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "", bargap = 0.8,
xaxis = list(title="<b>N° estud. 2022' no matriculados en 2023</b> <i>(% de matrícula 2022)</i>", font = list(family = "verdana", size = 16), showlegend = FALSE, showgrid = FALSE, showticklabels = FALSE, side = "top", range = list(0, max(data_plot4$n)*1.22)),
yaxis = list(title="<b>Establecimiento</b>", font = list(family = "verdana", size = 18), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1300, height = 1100, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
} else if(nrow(data_plot4) > 35 & nrow(data_plot4) < 66){
m <- m %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "",
xaxis = list(title="<b>N° estud. 2022 no matriculados en 2023</b> <i>(% de matrícula 2022)</i>", font = list(family = "verdana", size = 14), showlegend = FALSE, showgrid = FALSE, showticklabels = FALSE, side = "top", range = list(0, max(data_plot4$n)*1.22)),
yaxis = list(title="<b>Establecimiento</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
} else if(nrow(data_plot4) >= 66){
m <- m %>% layout(font = list(family = "verdana", color = '#007096', size = 16), title = "",
xaxis = list(title="<b>N° estud. 2022 no matriculados en 2023</b> <i>(% de matrícula 2022)</i>", font = list(family = "verdana", size = 14), showlegend = FALSE, showgrid = FALSE, showticklabels = FALSE, side = "top", range = list(0, max(data_plot4$n)*1.22)),
yaxis = list(title="<b>Establecimiento</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
} else{
m <- m %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "",
xaxis = list(title="<b>N° estud. 2022 no matriculados en 2023</b> <i>(% de matrícula 2022)</i>", font = list(family = "verdana", size = 16), showlegend = FALSE, showgrid = FALSE, showticklabels = FALSE, side = "top", range = list(0, max(data_plot4$n)*1.22)),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 18), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
}
# url_sost_desv_g = paste0("/Img temp/", "dep","_sost_desv_g.png")
# orca(m, url_sost_desv_g)
url_sost_desv_g = paste0(getwd(),"/Img temp/", "dep","_sost_desv_g.png")
save_image(m, url_sost_desv_g)
########## GRAFICO BARRA RETIRADOS POR DEPENDENCIA.
data_plot4_t_2 <- desvinc2 %>% group_by(rut_sost_rbd2022_ret) %>% summarise(n = n())
data_plot4_2
data_plot4_2  <- left_join(data_plot4_2, data_plot4_t_2, by=c("rut_sost_rbd2022"="rut_sost_rbd2022_ret"))
data_plot4_2
data_plot4_2  <- data_plot4_2 %>% mutate(n = ifelse(is.na(n), 0, n))
#data_plot4 <- data_plot4 %>% arrange(desc(n))
#data_plot4  <- left_join(data_plot4, data_plot4_n, by="nom_rbd2022r")
data_plot4_2 <- data_plot4_2 %>% mutate(n_total = ifelse(is.na(n_total), 0, n_total))
data_plot4_2 <- data_plot4_2 %>% mutate(porc_desvinc = ifelse(n_total != 0, 100*round(n/n_total, 3), 0))
data_plot4_2 <- data_plot4_2 %>% arrange(n)
data_plot4_2
#data_plot4_2$nom_rbd <- paste0(data_plot4_2$nom_rbd, " (RBD: ", data_plot4_2$rbd,")")
#data_plot4$nom_rbd2022r <- factor(data_plot4$nom_rbd2022r, levels = data_plot4$nom_rbd2022r)
#data_plot4$nom_rbd_2022r <- paste0(data_plot4$nom_rbd_2022r, " (RBD: ", data_plot4$rbd_2022r,")")
#data_plot4_2$cod_depe2 <- factor(data_plot4_2$cod_depe2, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
m2 <- plot_ly() %>% add_trace(x = ~data_plot4_2$n, y = ~data_plot4_2$nombre_sost_rbd2022, marker = list(color = "#6bccd6"), type = "bar", orientation = "h", text = paste0("<b style='color:#007096;'>",data_plot4_2$n,"</b>", "<i style='color:#007096';> (", data_plot4_2$porc_desvinc,"%)</i>"), textposition = "outside", textfont = list(family = "verdana", color = '#FFFFFF'))
if(nrow(data_plot4_2) < 4){
m2 <- m2 %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "", bargap = 0.8,
xaxis = list(title="<b>N° estud. retirados en 2023 sin matrícula</b> <i>(% de matrícula 2023)</i>", font = list(family = "verdana", size = 16), showlegend = FALSE, showgrid = FALSE, showticklabels = FALSE, side = "top", range = list(0, max(data_plot4_2$n)*1.22)),
yaxis = list(title="<b>Establecimiento</b>", font = list(family = "verdana", size = 18), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1300, height = 1100, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
} else if(nrow(data_plot4_2) > 35 & nrow(data_plot4_2) < 66){
m2 <- m2 %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "",
xaxis = list(title="<b>N° estud. retirados en 2023 sin matrícula</b> <i>(% de matrícula 2023)</i>", font = list(family = "verdana", size = 14), showlegend = FALSE, showgrid = FALSE, showticklabels = FALSE, side = "top", range = list(0, max(data_plot4_2$n)*1.22)),
yaxis = list(title="<b>Establecimiento</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
} else if(nrow(data_plot4_2) >= 66){
m2 <- m2 %>% layout(font = list(family = "verdana", color = '#007096', size = 16), title = "",
xaxis = list(title="<b>N° estud. retirados en 2023 sin matrícula</b> <i>(% de matrícula 2023)</i>", font = list(family = "verdana", size = 14), showlegend = FALSE, showgrid = FALSE, showticklabels = FALSE, side = "top", range = list(0, max(data_plot4_2$n)*1.22)),
yaxis = list(title="<b>Establecimiento</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
} else{
m2 <- m2 %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "",
xaxis = list(title="<b>N° estud. retirados en 2023 sin matrícula</b> <i>(% de matrícula 2023)</i>", font = list(family = "verdana", size = 16), showlegend = FALSE, showgrid = FALSE, showticklabels = FALSE, side = "top", range = list(0, max(data_plot4_2$n)*1.22)),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 18), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
}
# url_sost_desv_g_2 = paste0("/Img temp/", "dep","_sost_desv_g_2.png")
# orca(m2, url_sost_desv_g_2)
url_sost_desv_g_2 = paste0(getwd(),"/Img temp/", "dep","_sost_desv_g_2.png")
save_image(m2, url_sost_desv_g_2)
########## GRAFICO TORTA ESTUDIANTES POR EE DEL SOSTENEDOR.
#####
o <- plot_ly(data_plot5, labels = ~tipo_asis_2, values = ~round(prop,3), type = 'pie', hole = 0.5, textposition = 'outside',
textinfo = 'percent', sort = FALSE, marker = list(colors = ~color)) %>%
layout(legend = list(font = list(family = "verdana", size = 14, color = '#004677'), x=1.3 , y=0.5), font=list(family = "verdana", size = 18, color = '#004677'), xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
paper_bgcolor='transparent', autosize = TRUE, margin = list(l = -5, r = -5)
)
# url_sost_asist_g = paste0("/Img temp/", "dep","_sost_asist_g.png")
# orca(o, url_sost_asist_g)
url_sost_asist_g = paste0(getwd(),"/Img temp/", "dep","_sost_asist_g.png")
save_image(o, url_sost_asist_g)
########## GRAFICO BARRA ASIS CRIT POR EE DEL SOSTENEDOR.
data_plot6_t <- asis_crit %>% group_by(rut_sost_rbd2022) %>% summarise(n = n()) %>% ungroup()
data_plot6  <- left_join(data_plot6, data_plot6_t, by=c("rut_sost_rbd2022"))
data_plot6  <- data_plot6 %>% mutate(n = ifelse(is.na(n), 0, n))
data_plot6  <- data_plot6 %>% mutate(n_total = ifelse(is.na(n_total), 0, n_total))
data_plot6 <- data_plot6 %>% mutate(porc_asiscrit = ifelse(n_total != 0, 100*round(n/n_total, 3), 0))
data_plot6 <- data_plot6 %>% arrange(porc_asiscrit)
#data_plot6$nom_rbd <- factor(data_plot6$nom_rbd, levels = data_plot6$nom_rbd)
data_plot6$nom_rbd <- paste0(data_plot6$nom_rbd, " (RBD: ", data_plot6$rbd,")")
#data_plot6$cod_depe2 <- factor(data_plot6$cod_depe2, levels = c(1,2,3,4,5), labels = c("Municipal", "Particular Subvencionado", "Particular Pagado", "Administración Delegada", "Servicio Local de Educación"))
q <- plot_ly() %>% add_trace(x = ~data_plot6$porc_asiscrit, y = ~data_plot6$nombre_sost_rbd2022,  marker = list(color = "#6bccd6"), type = "bar", orientation = "h", text = paste0("<b style='color:#007096'>", data_plot6$porc_asiscrit, "%","</b>", "<i style='color:#007096';> (", data_plot6$n," de ", data_plot6$n_total,")</i>"), textposition = "outside", textfont = list(family = "verdana", color = '#FFFFFF'))
if(nrow(data_plot6) < 4){  #Si son pocos EE se achican las barras
q <- q %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "", bargap = 0.8,
#xaxis2 = list(title="<b>% Estudiantes con asistencia grave 2023</b>", font = list(family = "verdana", size = 8, color = "#e94860"), side = "top",
#             overlaying = "x", position=1,  range = list(0, max(data_plot6$porc_asiscrit) + 10), showgrid = FALSE, zeroline = FALSE,
#            tickfont = list(color = "#e94860"), ticksuffix = "%", titlefont = list(color = "#e94860")),
xaxis = list(title="<b>% estud. con asistencia bajo 85%</b> <i> (N° estud. sobre matrícula 2023)</i>", font = list(family = "verdana", size = 16), range = list(0, max(data_plot6$porc_asiscrit) + 26), showlegend = FALSE, ticksuffix = "%", showgrid = FALSE, side = "top"),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 18), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.1)
)
} else if(nrow(data_plot6) > 35 & nrow(data_plot6) < 66){
q <- q %>% layout(font = list(family = "verdana", color = '#007096', size = 18), title = "",
#xaxis2 = list(title="<b>% Estudiantes con asistencia grave 2023</b>", font = list(family = "verdana", size = 8, color = "#e94860"), side = "top",
#             overlaying = "x", position=1,  range = list(0, max(data_plot6$porc_asiscrit) + 10), showgrid = FALSE, zeroline = FALSE,
#            tickfont = list(color = "#e94860"), ticksuffix = "%", titlefont = list(color = "#e94860")),
xaxis = list(title="<b>% estud. con asistencia bajo 85%</b> <i> (N° estud. sobre matrícula 2023)</i>", font = list(family = "verdana", size = 16), range = list(0,  max(data_plot6$porc_asiscrit) + 26), showlegend = FALSE, ticksuffix = "%", showgrid = FALSE, side = "top"),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.15)
)
} else if(nrow(data_plot6) >= 66){
q <- q %>% layout(font = list(family = "verdana", color = '#007096', size = 16), title = "",
#xaxis2 = list(title="<b>% Estudiantes con asistencia grave 2023</b>", font = list(family = "verdana", size = 8, color = "#e94860"), side = "top",
#             overlaying = "x", position=1,  range = list(0, max(data_plot6$porc_asiscrit) + 10), showgrid = FALSE, zeroline = FALSE,
#            tickfont = list(color = "#e94860"), ticksuffix = "%", titlefont = list(color = "#e94860")),
xaxis = list(title="<b>% estud. con asistencia bajo 85%</b> <i> (N° estud. sobre matrícula 2023)</i>", font = list(family = "verdana", size = 14), range = list(0,  max(data_plot6$porc_asiscrit) + 26), showlegend = FALSE, ticksuffix = "%", showgrid = FALSE, side = "top"),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.15)
)
} else{
q <- q %>% layout(font = list(family = "verdana", color = '#007096', size = 16), title = "",
#xaxis2 = list(title="<b>% Estudiantes con asistencia grave 2023</b>", font = list(family = "verdana", size = 8, color = "#e94860"), side = "top",
#             overlaying = "x", position=1,  range = list(0, max(data_plot6$porc_asiscrit) + 10), showgrid = FALSE, zeroline = FALSE,
#            tickfont = list(color = "#e94860"), ticksuffix = "%", titlefont = list(color = "#e94860")),
xaxis = list(title="<b>% estud. con asistencia bajo 85%</b> <i> (N° estud. sobre matrícula 2023)</i>", font = list(family = "verdana", size = 16), range = list(0,  max(data_plot6$porc_asiscrit) + 26), showlegend = FALSE, ticksuffix = "%", showgrid = FALSE, side = "top"),
yaxis = list(title="<b>SLEP</b>", font = list(family = "verdana", size = 16), showlegend = FALSE, categoryorder = "total ascending"),
plot_bgcolor='transparent', paper_bgcolor='transparent', autosize = F, width = 1600, height = 2000, margin = list(l=-0.1, t = -0.1, r=-0.15)
)
}
# url_sost_asisgrave_g = paste0("/Img temp/", "dep","_sost_asisgrave_g.png")
# orca(q, url_sost_asisgrave_g)
url_sost_asisgrave_g = paste0(getwd(),"/Img temp/", "dep","_sost_asisgrave_g.png")
save_image(q, url_sost_asisgrave_g)
# #**************************************************************************************************************************/
# ## 3.2 RENDER  ----------------------------------------------------------------
# #**************************************************************************************************************************/
#
rmarkdown::render("Codigos/5 - DEP/RMKD Informe DEP (EPJA).Rmd",
params = list("cod_deprov" = rut_sost, "nom_deprov" = nom_sost, "desvinc" = desvinc, "desvinc2" = desvinc2, "desvinc3" = desvinc3, "asis_crit" = asis_crit, "url_sin_fin_g" = url_sin_fin_g, "url_cur_desv_g" = url_cur_desv_g, "url_asis_crit_g" = url_asis_crit_g, "url_sost_desv_g" = url_sost_desv_g, "url_sost_desv_g_2" = url_sost_desv_g_2, "url_cur_desv_g_2" = url_cur_desv_g_2, "url_sost_asist_g" = url_sost_asist_g,
"url_sost_asisgrave_g" = url_sost_asisgrave_g, "n_mat2022" = n_mat2022, "n_desvinc" = n_desvinc, "n_desvinc2" = n_desvinc2, "n_desvinc3" = n_desvinc3, "n_mat2023" = n_mat2023, "n_mat_asis2023" = n_mat_asis2023, "n_inasis2023" = n_inasis2023, "textos_variables_desvinculados" = textos_variables_desvinculados, "textos_variables_retirados" = textos_variables_retirados, "textos_variables_asistencia" = textos_variables_asistencia, "textos_variables_doble_desvinculados" = textos_variables_doble_desvinculados, "pass" = pass, "resumen_asis_sost" = resumen_asis_sost, "resumen_desvinc_sost" = resumen_desvinc_sost, "resumen_rbd" = resumen_rbd_ee),
output_file = paste0("Outputs/DEP/", "DEP (EPJA)", ".pdf"))
print(paste0("Listo ", i ," de ", nn, " Sost. (Codigo: ", "DEP", ")"))
#**************************************************************************************************************************/
## 3.3 EXCEL DEPROV  ----------------------------------------------------------------
#**************************************************************************************************************************/
#*
xsl_asis_ee_deprov <- xsl_asis_ee %>% filter(rut_sost_rbd2022 %in% rut_sost) %>% select(-c(rut_sost_rbd2022))
xsl_asis_ee_cur_deprov <- xsl_asis_ee_cur %>% filter(rut_sost_rbd2022 %in% rut_sost) %>% select(-c(rut_sost_rbd2022))
xls_desvinc_ee_deprov <- xls_desvinc_ee %>% filter(rut_sost_rbd2022 %in% rut_sost) %>% select(-c(rut_sost_rbd2022))
xls_desvinc_ee_cur_deprov <- xls_desvinc_ee_cur %>% filter(rut_sost_rbd2022 %in% rut_sost) %>% select(-c(rut_sost_rbd2022))
resumen_rbd_aux <- resumen_rbd %>% rename("Rut SLEP" = rut_sost_rbd2022)
desvinc0 <- desvinc %>% select("rbd_2022r", "nom_rbd_2022r", "run_alu2", "nom_alu2022", "app_alu2022", "apm_alu2022", "nom_grado", "edad_alu_2022r", "gen_alu_2022r", "nom_com_alu2022", "sit_fin_r_2022r", "cert_val_22", "valid_estud")
colnames(desvinc0) <- c("RBD", "Nombre Establecimiento", "RUN", "Nombre", "Apellido Parteno", "Apellido Materno", "Grado en 2022", "Edad 2022", "Sexo", "Comuna de residencia 2022", "Situación final 2022", "Validó estudios en 2022", "Inscrita/o para examen de validación 2023")
desvinc2_0 <- desvinc2 %>% select("rbd_ret", "nom_rbd_ret", "run_alu2_ret", "nom_alu_ret", "app_alu_ret", "apm_alu_ret", "nom_grado_ret", "edad_alu_ret", "gen_alu_ret", "nom_com_alu_ret", "fec_ret_rbd_ret", "valid_estud")
colnames(desvinc2_0) <- c("RBD", "Nombre Establecimiento", "RUN", "Nombre", "Apellido Parteno", "Apellido Materno","Grado en 2023", "Edad", "Sexo","Comuna de residencia 2023", "Fecha de retiro", "Inscrita/o para examen de validación 2023")
desvinc3_0 <- desvinc3 %>% select("rbd", "nom_rbd", "run_alu2", "nom_alu", "app_alu", "apm_alu", "nom_grado", "edad_alu", "gen_alu", "nom_com_alu", "sit_fin_r", "cert_val_21", "cert_val_22", "insc_val_23")
colnames(desvinc3_0) <- c("RBD", "Nombre Establecimiento", "RUN", "Nombre", "Apellido Parteno", "Apellido Materno", "Grado en 2021", "Edad 2021", "Sexo", "Comuna de residencia 2021", "Situación final 2021", "Validó estudios en 2021", "Validó estudios en 2022", "Inscrita/o para examen de validación 2023")
wb <- createWorkbook()
addWorksheet(wb, sheetName = "Resumen datos SLEP")
addWorksheet(wb, sheetName = "Nómina estud. retirados 2023")
addWorksheet(wb, sheetName = "Nómina estud. no matric 22-23")
addWorksheet(wb, sheetName = "Nómina estud. no matric 21-23")
addWorksheet(wb, sheetName = "Resumen no matric x RBD")
addWorksheet(wb, sheetName = "Resumen no matric x RBD y grado")
addWorksheet(wb, sheetName = "Resumen asist x RBD")
addWorksheet(wb, sheetName = "Resumen asist x RBD y grado")
writeData(wb, "Resumen datos SLEP", resumen_rbd_aux)
writeData(wb, "Nómina estud. retirados 2023", desvinc2_0)
writeData(wb, "Nómina estud. no matric 22-23", desvinc0)
writeData(wb, "Nómina estud. no matric 21-23", desvinc3_0)
writeData(wb, "Resumen no matric x RBD", xls_desvinc_ee_deprov)
writeData(wb, "Resumen no matric x RBD y grado", xls_desvinc_ee_cur_deprov)
writeData(wb, "Resumen asist x RBD", xsl_asis_ee_deprov)
writeData(wb, "Resumen asist x RBD y grado", xsl_asis_ee_cur_deprov)
pct = createStyle(numFmt="0.0%")
#addStyle(wb, "Resumen datos SLEP", style=pct, cols=c(2,3,6, 12:15, 18), rows=2:(nrow(resumen_rbd)+1), gridExpand=TRUE)
addStyle(wb, "Resumen datos SLEP", style=pct, cols=c(3:11,14, 20:24, 27), rows=2:(nrow(resumen_rbd)+1), gridExpand=TRUE)
addStyle(wb, "Resumen no matric x RBD", style=pct, cols=c(8), rows=2:(nrow(xls_desvinc_ee_deprov)+1), gridExpand=TRUE)
# addStyle(wb, "Resumen no matric x RBD y grado", style=pct, cols=c(8), rows=2:(nrow(xls_desvinc_ee_cur_deprov)+1), gridExpand=TRUE)
addStyle(wb, "Resumen asist x RBD", style=pct, cols=c(6:14, 17, 23:27), rows=2:(nrow(xsl_asis_ee_deprov)+1), gridExpand=TRUE)
addStyle(wb, "Resumen asist x RBD y grado", style=pct, cols=c(7:15, 18, 23:28), rows=2:(nrow(xsl_asis_ee_cur_deprov)+1), gridExpand=TRUE)
saveWorkbook(wb, paste0("Outputs/DEP/", "DEP", " (EPJA).xlsx"), overwrite = T)
toc()
}
